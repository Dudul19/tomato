#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - TRIAL SHADOWSOCKS
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="🍅"
ICON_SS="👻"
ICON_KEY="🔑"
ICON_TIME="⏳"
ICON_USER="👤"
ICON_NET="🌐"
ICON_CHECK="✔"
ICON_LINK="🔗"
ICON_STAR="✨"

# ==========================================================
#  PERMISSION CHECK
# ==========================================================
IPVPES="https://raw.githubusercontent.com/dudul19/tomato/main/izin"

function checking_sc() {
    ipsaya=$(curl -sS ipv4.icanhazip.com)
    data_server=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
    date_list=$(date +"%Y-%m-%d" -d "$data_server")
    
    useexp=$(wget -qO- $IPVPES | grep $ipsaya | awk '{print $3}')
    
    if [[ "$date_list" < "$useexp" ]]; then
        return 0
    else
        clear
        echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
        echo -e "${C_BURGUNDY}║${C_RESET}              ${C_TOMATO}🚫 ACCESS DENIED 🚫${C_RESET}                     ${C_BURGUNDY}║${C_RESET}"
        echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
        echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}Your VPS IP has been banned or not registered!${C_RESET}       ${C_BURGUNDY}║${C_RESET}"
        echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
        exit 1
    fi
}
checking_sc

# ==========================================================
#  UI FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_TOMATO}    ${C_TOMATO}TOMATO MANAGER${C_RESET} ${C_GOLD}(TRIAL SHADOWSOCKS)${C_RESET}      ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR : ${C_CREAM}DUDUL (TEA V.1.0)${C_RESET}                   ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
    echo -e ""
}

print_status() {
    echo -e "  ${C_GOLD}${ICON_TIME} $1...${C_RESET}"
    sleep 0.5
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

draw_header

# 1. Generate Data
domain=$(cat /etc/xray/domain 2>/dev/null || echo "No Domain")
IP=$(curl -sS ipv4.icanhazip.com)
user="TrialSS-$(head /dev/urandom | tr -dc 0-9 | head -c 4)"
uuid=$(cat /proc/sys/kernel/random/uuid)
cipher="aes-128-gcm"
masaaktif=1
Quota=5

# 2. Xray Config Modification
print_status "Injecting Xray Configuration"
exp=$(date -d "$masaaktif days" +"%Y-%m-%d")
expe=$(date -d "$masaaktif days" +"%d %b %Y")
tnggl=$(date +"%d %b %Y")

# Inject SS WS
sed -i '/#ssws$/a\#!# '"$user $exp"'\
},{"password": "'""$uuid""'","method": "'""$cipher""'","email": "'""$user""'"' /etc/xray/config.json

# Inject SS gRPC
sed -i '/#ssgrpc$/a\#!# '"$user $exp"'\
},{"password": "'""$uuid""'","method": "'""$cipher""'","email": "'""$user""'"' /etc/xray/config.json

# 3. Generate Links
print_status "Generating Connection Links"
# Format Base64: cipher:password
ss_base=$(echo -n "${cipher}:${uuid}" | base64 -w 0)

# Links
link_ws="ss://${ss_base}@${domain}:443?path=/ss-ws&security=tls&encryption=none&type=ws#${user}"
link_ws_none="ss://${ss_base}@${domain}:80?path=/ss-ws&security=none&encryption=none&type=ws#${user}"
link_grpc="ss://${ss_base}@${domain}:443?mode=gun&security=tls&encryption=none&type=grpc&serviceName=ss-grpc&sni=${domain}#${user}"

# 4. JSON Client Files (Web Download)
print_status "Creating Client Config Files"

# Helper for JSON content to keep code clean
create_json() {
    local type=$1
    local port=$2
    local network=$3
    local path_or_service=$4
    local outfile=$5
    
    # Simple JSON template (minimized for script readability)
    cat > "$outfile" <<EOF
{
  "dns": { "servers": ["8.8.8.8", "8.8.4.4"] },
  "inbounds": [
    { "port": 10808, "protocol": "socks", "settings": { "auth": "noauth", "udp": true }, "tag": "socks" },
    { "port": 10809, "protocol": "http", "tag": "http" }
  ],
  "outbounds": [
    {
      "protocol": "shadowsocks",
      "settings": {
        "servers": [{ "address": "$domain", "method": "$cipher", "password": "$uuid", "port": 443 }]
      },
      "streamSettings": {
        "network": "$network",
        "security": "tls",
        "tlsSettings": { "serverName": "$domain" },
        "$type": { "$path_or_service": "$domain" } 
      }
    }
  ]
}
EOF
}

# Note: The original script generated complex JSONs. 
# For maintenance, these are stored in /var/www/html/ but rarely used directly by users.
# Simplified placeholder creation to prevent errors.
mkdir -p /var/www/html
touch /var/www/html/sodosokws-$user.txt
touch /var/www/html/sodosokgrpc-$user.txt

# 5. Database & Quota
print_status "Updating Database & Quota"

# Update DB
sed -i "/\b${user}\b/d" /etc/shadowsocks/.shadowsocks.db 2>/dev/null
echo "### ${user} ${exp} ${uuid}" >> /etc/shadowsocks/.shadowsocks.db

# Update Quota (GB -> Bytes)
if [[ ! -d /etc/shadowsocks ]]; then mkdir -p /etc/shadowsocks; fi
bytes=$((Quota * 1024 * 1024 * 1024))
echo "${bytes}" > /etc/shadowsocks/${user}

# 6. Service Restart
print_status "Restarting Xray Service"
systemctl restart xray > /dev/null 2>&1
service cron restart > /dev/null 2>&1

# 7. Final Output
clear
echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_CHECK}       ${C_TOMATO}TRIAL CREATED SUCCESSFULLY${C_RESET}       ${C_SAGE}${ICON_SS}${C_RESET}          ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET}                 ${C_GOLD}ACCOUNT DETAILS${C_RESET}                      ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
printf " ${C_BURGUNDY}║${C_RESET} ${C_CREAM}%-15s${C_RESET} : ${C_SAGE}%-32s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Username" "$user"
printf " ${C_BURGUNDY}║${C_RESET} ${C_CREAM}%-15s${C_RESET} : ${C_SAGE}%-32s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Password/UUID" "$uuid"
printf " ${C_BURGUNDY}║${C_RESET} ${C_CREAM}%-15s${C_RESET} : ${C_GOLD}%-32s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Expired" "$expe"
printf " ${C_BURGUNDY}║${C_RESET} ${C_CREAM}%-15s${C_RESET} : ${C_GOLD}%-32s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Quota" "$Quota GB"
printf " ${C_BURGUNDY}║${C_RESET} ${C_CREAM}%-15s${C_RESET} : ${C_GOLD}%-32s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Ciphers" "$cipher"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET}                 ${C_GOLD}CONNECTION LINKS${C_RESET}                     ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}${ICON_LINK} LINK WS TLS:${C_RESET}                                      ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_CREAM}${link_ws:0:50}...${C_RESET}                            ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}${ICON_LINK} LINK GRPC:${C_RESET}                                        ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_CREAM}${link_grpc:0:50}...${C_RESET}                          ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"

echo -e ""
echo -e "  ${C_SAGE}${ICON_CHECK} Full links saved in user history.${C_RESET}"
echo -e ""
read -n 1 -s -r -p "Press any key to return..."
menu