#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - BACKUP MANAGER
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="ğŸ…"
ICON_STAR="âœ¨"
ICON_CLOUD="â˜ï¸"
ICON_CHECK="âœ”"
ICON_CROSS="âœ–"
ICON_GEAR="âš™"
ICON_LOCK="ğŸ”’"
ICON_MAIL="ğŸ“§"

# ==========================================================
#  HELPER FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_TOMATO}    ${C_TOMATO}TOMATO CLOUD BACKUP${C_RESET} ${C_GOLD}(GOOGLE DRIVE)${C_RESET}         ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR : ${C_CREAM}DUDUL (TEA V.1.0)${C_RESET}                   ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    echo -e ""
}

print_status() {
    echo -e "  ${C_GOLD}${ICON_GEAR} $1...${C_RESET}"
    sleep 0.5
}

print_success() {
    echo -e "  ${C_SAGE}${ICON_CHECK} SUCCESS:${C_RESET} ${C_CREAM}$1${C_RESET}"
    sleep 0.5
}

print_error() {
    echo -e "  ${C_TOMATO}${ICON_CROSS} ERROR:${C_RESET} ${C_CREAM}$1${C_RESET}"
}

# ==========================================================
#  INITIALIZATION
# ==========================================================

# Check Dependencies
if ! command -v zip &> /dev/null; then
    echo -e "${C_TOMATO}Error: 'zip' is not installed. Installing...${C_RESET}"
    apt-get install zip -y > /dev/null 2>&1
fi
if ! command -v rclone &> /dev/null; then
    echo -e "${C_TOMATO}Error: 'rclone' is not installed.${C_RESET}"
    exit 1
fi

# Load Bot Data
CHATID=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3)
KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 2)
TIME="10"
URL="https://api.telegram.org/bot$KEY/sendMessage"

# System Data
IP=$(curl -sS ipv4.icanhazip.com)
domain=$(cat /etc/xray/domain)
date=$(date +"%Y-%m-%d")
timestamp=$(date +"%Y%m%d_%H%M%S")

# Check Email Config
email=$(cat /root/email 2>/dev/null)
draw_header
if [[ "$email" = "" ]]; then
    echo -e "  ${C_GOLD}[?] Input Email for Notification :${C_RESET}"
    read -p "      > " -e email
    echo "$email" > /root/email
fi

# ==========================================================
#  BACKUP PROCESS
# ==========================================================

echo -e "  ${C_SAGE}${ICON_CLOUD} Starting Backup Process...${C_RESET}"
echo -e ""

# 1. Prepare Directory
BACKUP_DIR="/root/backup_${timestamp}"
BACKUP_FILE="/root/backup_${IP}_${timestamp}.zip"
BACKUP_FILE_NAME="backup_${IP}_${timestamp}.zip"

print_status "Creating Temporary Directory"
mkdir -p "$BACKUP_DIR"

# 2. Copy System Files
print_status "Backing up System Configuration"
cp /etc/passwd "$BACKUP_DIR/"
cp /etc/group "$BACKUP_DIR/"
cp /etc/shadow "$BACKUP_DIR/"
cp /etc/gshadow "$BACKUP_DIR/"
cp /etc/crontab "$BACKUP_DIR/"
if [ -f /etc/xray/domain ]; then cp /etc/xray/domain "$BACKUP_DIR/"; fi

# 3. Copy Application Data
print_status "Backing up Application Data (Xray/Web)"
if [ -d /var/lib/kyt/ ]; then cp -r /var/lib/kyt/ "$BACKUP_DIR/"; fi
if [ -d /etc/xray ]; then cp -r /etc/xray "$BACKUP_DIR/"; fi
if [ -d /var/www/html/ ]; then cp -r /var/www/html/ "$BACKUP_DIR/"; fi
if [ -d /etc/zivpn/ ]; then cp -r /etc/zivpn/ "$BACKUP_DIR/"; fi

# 4. Zipping
print_status "Compressing Data (ZIP)"
cd "$BACKUP_DIR" || exit
zip -r "$BACKUP_FILE" . > /dev/null 2>&1
if [ $? -eq 0 ]; then
    print_success "Compression Complete"
else
    print_error "Compression Failed"
    exit 1
fi

# 5. Upload to Google Drive
print_status "Uploading to Google Drive"
rclone copy "$BACKUP_FILE" dr:backup/ > /dev/null 2>&1
if [ $? -eq 0 ]; then
    print_success "Upload Successful"
else
    print_error "Upload Failed. Check Rclone Config."
    exit 1
fi

# 6. Get Link
print_status "Generating Download Link"
url=$(rclone link dr:backup/"$BACKUP_FILE_NAME" 2>/dev/null)
if [[ "$url" =~ "id=" ]]; then
    id=$(echo "$url" | grep -oP 'id=\K[^&]+')
    link="https://drive.google.com/u/4/uc?id=${id}&export=download"
else
    link="Link Generation Failed"
fi

# ==========================================================
#  NOTIFICATIONS
# ==========================================================

# 7. Send Email
if command -v mail &> /dev/null; then
    print_status "Sending Email Notification"
    email_content="
Detail Backup VPS
==================================
IP VPS        : $IP
Domain        : $domain
Date          : $date
Time          : $(date +"%H:%M:%S")
Filename      : $BACKUP_FILE_NAME
Download Link : $link
==================================
Automated Message by Tomato Autoscript
"
    timeout 30s mail -s "Backup Data $date" "$email" <<< "$email_content"
    print_success "Email Sent to $email"
else
    echo -e "  ${C_GOLD}${ICON_MAIL} Warning: mailutils not installed (Skipped)${C_RESET}"
fi

# 8. Send Telegram
print_status "Sending Telegram Notification"
TEXT="
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>  ğŸ… BACKUP NOTIFICATION ğŸ…</b>
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>IP VPS   :</b> <code>$IP</code>
<b>Domain   :</b> <code>$domain</code>
<b>Date     :</b> <code>$date</code>
<b>Time     :</b> <code>$(date +"%H:%M:%S")</code>
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>File Name:</b> <code>$BACKUP_FILE_NAME</code>
<b>G-Drive  :</b> <a href='$link'>Click Here to Download</a>
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<code>Please copy the link and restore on new VPS</code>
"
curl -s --max-time $TIME -d "chat_id=$CHATID&disable_web_page_preview=0&text=$TEXT&parse_mode=html" "$URL" >/dev/null

# 9. Cleanup
print_status "Cleaning Up Temporary Files"
rm -rf "$BACKUP_DIR"
# Optional: Remove local zip to save space
# rm -f "$BACKUP_FILE"

# ==========================================================
#  FINAL REPORT
# ==========================================================
clear
echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_CHECK}       ${C_TOMATO}BACKUP COMPLETED SUCCESSFULLY${C_RESET}        ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}File Name :${C_RESET} ${C_CREAM}$BACKUP_FILE_NAME${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}Location  :${C_RESET} ${C_CREAM}$BACKUP_FILE${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}Date      :${C_RESET} ${C_CREAM}$date${C_RESET}"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}Link      :${C_RESET} ${C_SAGE}$link${C_RESET}"
echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"

echo -e ""
echo -e "${C_SAGE}${ICON_STAR} Notification sent to Telegram & Email.${C_RESET}"
echo -e ""
read -n 1 -s -r -p "Press any key to return..."
menu