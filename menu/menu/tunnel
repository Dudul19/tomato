#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - TRIAL CLEANER
# ==========================================================

# 1. Palette Definition
C_TOMATO="\033[38;2;217;69;57m"
C_BURGUNDY="\033[38;2;143;38;38m"
C_SAGE="\033[38;2;148;180;159m"
C_GOLD="\033[38;2;230;203;165m"
C_CREAM="\033[38;2;253;251;247m"
C_RESET="\033[0m"

# 2. Arguments
PROTOCOL="$1"
USER="$2"

# 3. Helper UI (Hanya muncul jika dijalankan manual)
print_status() {
    if [ -t 0 ]; then echo -e "  ${C_GOLD}âš™ $1...${C_RESET}"; fi
}

print_success() {
    if [ -t 0 ]; then echo -e "  ${C_SAGE}âœ” $1${C_RESET}"; fi
}

# ==========================================================
#  DELETION FUNCTIONS
# ==========================================================

function delete_ssh(){
    print_status "Deleting SSH Account: $USER"
    
    # Hapus User System
    if getent passwd "$USER" > /dev/null 2>&1; then
        userdel -f "$USER" > /dev/null 2>&1
    fi
    
    # Hapus Database
    sed -i "/^#ssh# $USER /d" /etc/ssh/.ssh.db
    
    # Hapus File Web
    rm -f "/var/www/html/ssh-$USER.txt"
    
    # Hapus Cronjob Trial
    rm -f "/etc/cron.d/trialssh-$USER"
    
    # Refresh Service
    service cron restart > /dev/null 2>&1
    print_success "SSH Account Removed"
}

function delete_vmess(){
    print_status "Deleting VMess Account: $USER"
    
    # Hapus Config Xray (Regex: dari baris user sampai penutup bracket)
    # Mencari baris komen ### User Expired
    exp=$(grep -wE "^### $USER" "/etc/xray/config.json" | cut -d ' ' -f 3 | sort | uniq | head -n 1)
    
    if [[ ! -z "$exp" ]]; then
        sed -i "/^### $USER $exp/,/^},{/d" /etc/xray/config.json
        sed -i "/^### $USER $exp/,/^},{/d" /etc/vmess/.vmess.db
    fi

    # Hapus File Sampah / Log / Limit
    rm -rf /etc/vmess/$USER
    rm -rf /etc/kyt/limit/vmess/ip/$USER
    rm -rf /etc/vmess/quota-asli/$USER
    rm -rf /etc/vmess/limit/$USER
    
    # Hapus File Web Config
    rm -f /var/www/html/vmess-$USER.txt
    rm -f /home/vps/public_html/$USER-*.yaml # Legacy support
    
    print_success "VMess Account Removed"
}

function delete_vless(){
    print_status "Deleting VLESS Account: $USER"
    
    exp=$(grep -wE "^#& $USER" "/etc/xray/config.json" | cut -d ' ' -f 3 | sort | uniq | head -n 1)
    
    if [[ ! -z "$exp" ]]; then
        sed -i "/^#& $USER $exp/,/^},{/d" /etc/xray/config.json
        sed -i "/^#& $USER $exp/,/^},{/d" /etc/vless/.vless.db
    fi

    rm -rf /etc/vless/$USER
    rm -rf /etc/kyt/limit/vless/ip/$USER
    rm -rf /etc/vless/quota-asli/$USER
    rm -rf /etc/vless/limit/$USER
    
    rm -f /var/www/html/vless-$USER.txt
    rm -f /home/vps/public_html/$USER-*.yaml
    
    print_success "VLESS Account Removed"
}

function delete_trojan(){
    print_status "Deleting Trojan Account: $USER"
    
    exp=$(grep -wE "^#! $USER" "/etc/xray/config.json" | cut -d ' ' -f 3 | sort | uniq | head -n 1)
    
    if [[ ! -z "$exp" ]]; then
        sed -i "/^#! $USER $exp/,/^},{/d" /etc/xray/config.json
        sed -i "/^#! $USER $exp/,/^},{/d" /etc/trojan/.trojan.db
    fi

    rm -rf /etc/trojan/$USER
    rm -rf /etc/kyt/limit/trojan/ip/$USER
    rm -rf /etc/trojan/quota-asli/$USER
    rm -rf /etc/trojan/limit/$USER
    
    rm -f /var/www/html/trojan-$USER.txt
    rm -f /home/vps/public_html/$USER-*.yaml
    
    print_success "Trojan Account Removed"
}

function delete_ssws(){
    print_status "Deleting Shadowsocks Account: $USER"
    
    exp=$(grep -wE "^#ssws $USER" "/etc/xray/config.json" | cut -d ' ' -f 3 | sort | uniq | head -n 1)
    # Fallback regex untuk format lama
    if [[ -z "$exp" ]]; then
         exp=$(grep -wE "^##@ $USER" "/etc/xray/config.json" | cut -d ' ' -f 3 | sort | uniq | head -n 1)
    fi

    if [[ ! -z "$exp" ]]; then
        sed -i "/^#ssws $USER $exp/,/^},{/d" /etc/xray/config.json
        sed -i "/^##@ $USER $exp/,/^},{/d" /etc/xray/config.json
        sed -i "/\b$USER\b/d" /etc/shadowsocks/.shadowsocks.db
    fi

    rm -rf /etc/shadowsocks/$USER
    rm -rf /etc/kyt/limit/shadowsocks/ip/$USER
    rm -rf /etc/shadowsocks/limit/$USER
    
    rm -f /var/www/html/sodosokws-$USER.txt
    rm -f /var/www/html/sodosokgrpc-$USER.txt
    
    print_success "Shadowsocks Account Removed"
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

# Header jika manual
if [ -t 0 ]; then
    clear
    echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}ðŸ… TOMATO TRIAL CLEANER${C_RESET}                                ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
fi

case "$PROTOCOL" in
    ssh)
        delete_ssh
        ;;
    vmess)
        delete_vmess
        systemctl restart xray > /dev/null 2>&1
        ;;
    vless)
        delete_vless
        systemctl restart xray > /dev/null 2>&1
        ;;
    trojan)
        delete_trojan
        systemctl restart xray > /dev/null 2>&1
        ;;
    ssws|shadowsocks)
        delete_ssws
        systemctl restart xray > /dev/null 2>&1
        ;;
    *)
        if [ -t 0 ]; then
            echo -e "  ${C_TOMATO}Usage: $0 {ssh|vmess|vless|trojan|ssws} username${C_RESET}"
        fi
        exit 1
        ;;
esac