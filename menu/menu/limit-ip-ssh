#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - SSH LIMITER
# ==========================================================

# 1. Palette Definition
C_TOMATO="\033[38;2;217;69;57m"
C_BURGUNDY="\033[38;2;143;38;38m"
C_SAGE="\033[38;2;148;180;159m"
C_GOLD="\033[38;2;230;203;165m"
C_CREAM="\033[38;2;253;251;247m"
C_RESET="\033[0m"

# 2. Setup Logs
LOG_DIR="/etc/kyt/log/ssh"
LOG_FILE="$LOG_DIR/ssh.log"

if [[ ! -d "$LOG_DIR" ]]; then
    mkdir -p "$LOG_DIR"
fi

# ==========================================================
#  TELEGRAM NOTIFICATION FUNCTION
# ==========================================================
send_log(){
    local user=$1
    local limit=$2
    local active=$3
    
    CHATID=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3)
    KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 2)
    TIME="10"
    URL="https://api.telegram.org/bot$KEY/sendMessage"
    
    if [[ ! -z "$CHATID" && ! -z "$KEY" ]]; then
        TEXT="
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>âš ï¸ SSH MULTI-LOGIN ALERT âš ï¸</b>
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>Username  :</b> <code>$user</code>
<b>Limit     :</b> <code>$limit</code>
<b>Active    :</b> <code>$active</code>
<b>Action    :</b> <code>LOCKED & KILLED</code>
<b>Time      :</b> <code>$(date +"%H:%M:%S")</code>
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>Server IP :</b> <code>$(curl -sS ipv4.icanhazip.com)</code>
"
        curl -s --max-time $TIME -d "chat_id=$CHATID&disable_web_page_preview=1&text=$TEXT&parse_mode=html" $URL >/dev/null
    fi
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

# Jika dijalankan manual, tampilkan Header. Jika cron, silent.
if [ -t 1 ]; then
    clear
    echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}ğŸ…${C_RESET}    ${C_TOMATO}TOMATO SECURITY${C_RESET} ${C_GOLD}(SSH LIMIT MONITOR)${C_RESET}       ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    echo -e ""
    echo -e "  ${C_GOLD}âš™ Checking active sessions...${C_RESET}"
fi

# Loop Check User
for user in $(ls /etc/kyt/limit/ssh/ip); do
    # Ambil Limit User
    iplimit=$(cat /etc/kyt/limit/ssh/ip/$user)
    
    # Hitung Login Aktif (Menggunakan ps -ef untuk akurasi sshd process)
    # Menghitung proses sshd: user@...
    cekcek=$(ps -ef | grep "sshd: $user@" | grep -v grep | wc -l)

    # Validasi Multi-Login
    if [[ $cekcek -gt $iplimit ]]; then
        if [ -t 1 ]; then
            echo -e "  ${C_TOMATO}âœ– VIOLATION:${C_RESET} ${C_CREAM}$user${C_RESET} (Active: $cekcek / Limit: $iplimit)"
        fi

        # 1. Lock Account
        passwd -l $user > /dev/null 2>&1
        
        # 2. Kill Active Sessions (TENDANG USER!)
        pkill -u $user
        
        # 3. Write Log
        waktu=$(date +"%d-%m-%Y %H:%M:%S")
        echo -e "$waktu | Removed User: $user | Login: $cekcek | Max: $iplimit" >> $LOG_FILE
        
        # 4. Send Telegram
        send_log "$user" "$iplimit" "$cekcek"
    else
        # Jika aman, dan dijalankan manual, tampilkan status OK
        if [ -t 1 ]; then
             echo -e "  ${C_SAGE}âœ” SAFE:${C_RESET} ${C_CREAM}$user${C_RESET} ($cekcek/$iplimit)"
        fi
    fi
    sleep 0.1
done

if [ -t 1 ]; then
    echo -e ""
    echo -e "  ${C_SAGE}âœ” Check Completed.${C_RESET}"
    echo -e ""
fi