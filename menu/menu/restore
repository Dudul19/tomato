#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - SYSTEM RESTORE
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="ðŸ…"
ICON_RESTORE="â™»ï¸"
ICON_FILE="ðŸ“"
ICON_CLOUD="â˜ï¸"
ICON_WARN="âš ï¸"
ICON_CHECK="âœ”"
ICON_CROSS="âœ–"
ICON_GEAR="âš™"
ICON_KEY="ðŸ”‘"
ICON_STAR="âœ¨"

# 3. Check Root
if [ "$(id -u)" != "0" ]; then
    echo -e "${C_TOMATO}Error: Script must be run as root${C_RESET}"
    exit 1
fi

# ==========================================================
#  UI FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_TOMATO}    ${C_TOMATO}TOMATO MANAGER${C_RESET} ${C_GOLD}(SYSTEM RESTORE)${C_RESET}           ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR : ${C_CREAM}DUDUL (TEA V.1.0)${C_RESET}                   ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    echo -e ""
}

print_status() {
    echo -e "  ${C_GOLD}${ICON_GEAR} $1...${C_RESET}"
    sleep 0.5
}

print_success() {
    echo -e "  ${C_SAGE}${ICON_CHECK} $1${C_RESET}"
    sleep 0.3
}

print_error() {
    echo -e "  ${C_TOMATO}${ICON_CROSS} $1${C_RESET}"
    sleep 1
}

# ==========================================================
#  CORE RESTORE LOGIC
# ==========================================================

process_restore() {
    local backup_file="$1"
    local temp_dir="/root/restore_temp"

    # 1. Konfirmasi
    echo -e "${C_BURGUNDY}  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${C_RESET}"
    echo -e "  ${C_TOMATO}${ICON_WARN} WARNING: This action will overwrite system files!${C_RESET}"
    echo -e "  ${C_CREAM}Config, Users, and VPN Data will be replaced.${C_RESET}"
    echo -e ""
    read -p "  Are you sure? (y/n): " confirm
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        print_error "Restore Cancelled."
        return
    fi

    # 2. Input Password
    read -p "  ${ICON_KEY} Enter Backup Password: " backup_pass

    # 3. Extracting
    print_status "Preparing Temporary Directory"
    rm -rf "$temp_dir"
    mkdir -p "$temp_dir"

    print_status "Extracting Backup Archive"
    # Coba unzip dengan password
    if ! unzip -P "$backup_pass" -o "$backup_file" -d "$temp_dir" > /dev/null 2>&1; then
        print_error "Extraction Failed! Wrong Password or Corrupt File."
        rm -rf "$temp_dir"
        return
    fi

    # 4. Validasi Struktur (Mencegah restore file sampah)
    # Struktur diharapkan: restore_temp/backup/passwd, dll.
    # Namun kadang zip dibuat tanpa parent folder 'backup'. Kita cek keduanya.
    
    BASE_DIR="$temp_dir"
    if [[ -d "$temp_dir/backup" ]]; then
        BASE_DIR="$temp_dir/backup"
    fi

    if [[ ! -f "$BASE_DIR/passwd" ]]; then
        print_error "Invalid Backup Structure. Missing system files."
        rm -rf "$temp_dir"
        return
    fi

    # 5. Restore Process
    print_status "Restoring System Credentials"
    cp "$BASE_DIR/passwd" /etc/
    cp "$BASE_DIR/group" /etc/
    cp "$BASE_DIR/shadow" /etc/
    cp "$BASE_DIR/gshadow" /etc/

    if [[ -d "$BASE_DIR/xray" ]]; then
        print_status "Restoring Xray Configuration"
        rm -rf /etc/xray
        cp -r "$BASE_DIR/xray" /etc/
        chmod -R 755 /etc/xray
    fi

    if [[ -d "$BASE_DIR/kyt" ]]; then
        print_status "Restoring VPN Data & Limits"
        rm -rf /var/lib/kyt
        cp -r "$BASE_DIR/kyt" /var/lib/
    fi

    if [[ -d "$BASE_DIR/html" ]]; then
        print_status "Restoring Web Files"
        rm -rf /var/www/html
        cp -r "$BASE_DIR/html" /var/www/
    fi

    # Restore Quota/Limits specific paths if needed (based on previous backup scripts)
    if [[ -d "$BASE_DIR/vmess" ]]; then cp -r "$BASE_DIR/vmess" /etc/; fi
    if [[ -d "$BASE_DIR/vless" ]]; then cp -r "$BASE_DIR/vless" /etc/; fi
    if [[ -d "$BASE_DIR/trojan" ]]; then cp -r "$BASE_DIR/trojan" /etc/; fi

    # 6. Restart Services
    print_status "Restarting Services"
    systemctl restart xray > /dev/null 2>&1
    systemctl restart nginx > /dev/null 2>&1
    systemctl restart ssh > /dev/null 2>&1
    systemctl restart dropbear > /dev/null 2>&1

    # 7. Cleanup
    rm -rf "$temp_dir"
    
    echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_CHECK}       ${C_TOMATO}RESTORE COMPLETED SUCCESSFULLY${C_RESET}      ${C_SAGE}${ICON_RESTORE}${C_RESET}        ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    echo -e ""
    read -n 1 -s -r -p "Press any key to return..."
    menu
}

# ==========================================================
#  SOURCE SELECTION
# ==========================================================

draw_header

echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET}                ${C_GOLD}SELECT RESTORE SOURCE${C_RESET}                 ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}[01]${C_RESET} ${C_CREAM}Local File (root directory)${C_RESET}   ${C_SAGE}${ICON_FILE}${C_RESET}              ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}[02]${C_RESET} ${C_CREAM}Google Drive Link${C_RESET}             ${C_SAGE}${ICON_CLOUD}${C_RESET}              ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_TOMATO}[00]${C_RESET} ${C_TOMATO}Back to Menu${C_RESET}                  ${C_GOLD}${ICON_STAR}${C_RESET}              ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
echo -e ""

read -p "  Select Option : " opt
echo -e ""

case $opt in
    1|01)
        echo -e "${C_GOLD}  Available Backups in /root:${C_RESET}"
        # Cek apakah ada file zip
        count=$(ls /root/*.zip 2>/dev/null | wc -l)
        if [[ $count -eq 0 ]]; then
            print_error "No .zip backup files found in /root"
            read -n 1 -s -r -p "Press any key to return..."
            menu-backup
            exit 0
        fi
        
        ls -lh /root/*.zip | awk '{print "  - " $9 " (" $5 ")"}'
        echo -e ""
        read -p "  Enter Full Filename (e.g., backup.zip): " filename
        
        if [[ -f "/root/$filename" ]]; then
            process_restore "/root/$filename"
        else
            print_error "File not found!"
            menu-backup
        fi
        ;;
    2|02)
        echo -e "  ${C_CREAM}Paste your Google Drive Link:${C_RESET}"
        read -p "  > " url
        
        # Extract File ID (Simple regex)
        file_id=$(echo "$url" | grep -o '[a-zA-Z0-9_-]\{28,\}')
        
        if [[ -z "$file_id" ]]; then
            print_error "Invalid Google Drive Link!"
            menu-backup
            exit 1
        fi
        
        DOWNLOAD_PATH="/root/restore_gdrive_${file_id}.zip"
        print_status "Downloading from Google Drive"
        
        # Download Attempt
        if wget --quiet --show-progress "https://drive.google.com/uc?export=download&id=$file_id" -O "$DOWNLOAD_PATH"; then
             process_restore "$DOWNLOAD_PATH"
             rm -f "$DOWNLOAD_PATH" # Cleanup downloaded file
        else
             print_error "Download Failed."
             menu-backup
        fi
        ;;
    0|00)
        menu
        ;;
    *)
        menu-backup
        ;;
esac