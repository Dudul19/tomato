#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - BOT BACKUP MANAGER
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="ğŸ…"
ICON_BOT="ğŸ¤–"
ICON_BACKUP="ğŸ’¾"
ICON_RESTORE="â™»ï¸"
ICON_ON="ğŸŸ¢"
ICON_OFF="ğŸ”´"
ICON_UPLOAD="â˜ï¸"
ICON_DOWNLOAD="â¬‡ï¸"
ICON_KEY="ğŸ”‘"
ICON_STAR="âœ¨"
ICON_EXIT="ğŸ”™"

# 3. Check Dependencies
if ! command -v zip &> /dev/null; then apt-get install zip -y; fi
if ! command -v unzip &> /dev/null; then apt-get install unzip -y; fi
if ! command -v jq &> /dev/null; then apt-get install jq -y; fi

# ==========================================================
#  HELPER FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_TOMATO}    ${C_TOMATO}TOMATO MANAGER${C_RESET} ${C_GOLD}(BOT BACKUP)${C_RESET}               ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR : ${C_CREAM}DUDUL (TEA V.1.0)${C_RESET}                   ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    echo -e ""
}

print_status() {
    echo -e "  ${C_GOLD}${ICON_STAR} $1...${C_RESET}"
    sleep 0.5
}

print_success() {
    echo -e "  ${C_SAGE}${ICON_ON} $1${C_RESET}"
    sleep 0.5
}

# ==========================================================
#  CORE FUNCTIONS
# ==========================================================

setup_bot() {
    draw_header
    echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
    echo -e "${C_BURGUNDY}  |${C_RESET}                   ${C_GOLD}SETUP BOT${C_RESET}                        ${C_BURGUNDY}|${C_RESET}"
    echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"
    echo -e "  ${C_CREAM}1. Create bot at @BotFather -> /newbot${C_RESET}"
    echo -e "  ${C_CREAM}2. Get ID at @MissRose_bot -> /id${C_RESET}"
    echo -e ""
    
    read -p "  ${ICON_KEY} Bot Token : " getToken
    read -p "  ${ICON_BOT} Admin ID  : " adminID
    
    # Simpan Config
    echo "$getToken" > /root/.bckupbot
    echo "$adminID" >> /root/.bckupbot
    echo "switch off" >> /root/.bckupbot
    
    print_success "Bot Configuration Saved!"
    read -n 1 -s -r -p "Press any key to return..."
    botbckpBot_menu
}

botBackup() {
    draw_header
    # Load Config
    if [[ ! -f /root/.bckupbot ]]; then
        echo -e "  ${C_TOMATO}Error: Bot not configured.${C_RESET}"
        sleep 2; botbckpBot_menu
    fi
    bottoken=$(sed -n '1p' /root/.bckupbot | awk '{print $1}')
    adminid=$(sed -n '2p' /root/.bckupbot | awk '{print $1}')
    
    # Metadata
    IP=$(curl -sS ipv4.icanhazip.com)
    dateToday=$(date +"%Y-%m-%d")
    Name=$(curl -sS https://raw.githubusercontent.com/dudul19/tomato/main/izin | grep $IP | awk '{print $2}')
    if [[ -z "$Name" ]]; then Name="Unknown"; fi

    echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
    echo -e "${C_BURGUNDY}  |${C_RESET}                 ${C_GOLD}BACKUP PROCESS${C_RESET}                       ${C_BURGUNDY}|${C_RESET}"
    echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"
    
    read -p "  ${ICON_KEY} Input Password for Backup File : " InputPass
    if [[ -z $InputPass ]]; then InputPass="kytvpnpassword"; fi
    
    print_status "Preparing Directories"
    DIR="/root/backup"
    rm -rf $DIR &> /dev/null
    mkdir -p $DIR
    
    # Copy Data
    print_status "Backing up System Configs"
    cp /etc/passwd $DIR/
    cp /etc/group $DIR/
    cp /etc/shadow $DIR/
    cp /etc/gshadow $DIR/
    
    print_status "Backing up VPS Data (Xray/Kyt/Html)"
    cp -r /var/lib/kyt $DIR/kyt &> /dev/null
    cp -r /etc/xray $DIR/xray &> /dev/null
    cp -r /var/www/html $DIR/html &> /dev/null
    cp -r /etc/user $DIR/user &> /dev/null
    
    print_status "Backing up User Quotas & Limits"
    mkdir -p $DIR/vmess $DIR/vless $DIR/trojan $DIR/ssh
    
    # Copy Quota
    cp -r /etc/vmess $DIR/vmess/quota &> /dev/null
    cp -r /etc/vless $DIR/vless/quota &> /dev/null
    cp -r /etc/trojan $DIR/trojan/quota &> /dev/null
    
    # Copy Limits (Standardized Path)
    mkdir -p $DIR/limit
    cp -r /etc/kyt/limit/* $DIR/limit/ &> /dev/null

    # Zipping
    print_status "Compressing Data"
    cd /root
    zip -rP "$InputPass" "$IP-$Name-$dateToday.zip" backup > /dev/null 2>&1
    
    # Uploading
    print_status "Uploading to Telegram"
    FILE="$IP-$Name-$dateToday.zip"
    CAPTION="ğŸ… <b>TOMATO BACKUP</b> ğŸ…%0A%0AğŸ“… Date: <code>$dateToday</code>%0AğŸ‘¤ User: <code>$Name</code>%0AğŸ”‘ Pass: <code>$InputPass</code>%0AğŸ–¥ï¸ IP: <code>$IP</code>"
    
    # Upload Document
    RESP=$(curl -s --request POST \
        --url "https://api.telegram.org/bot${bottoken}/sendDocument" \
        --form chat_id="${adminid}" \
        --form caption="${CAPTION}" \
        --form parse_mode="html" \
        --form document=@"/root/$FILE")
        
    # Extract File ID
    fileId=$(echo $RESP | jq -r '.result.document.file_id')
    
    if [[ "$fileId" != "null" ]]; then
        curl -s --request POST \
        --url "https://api.telegram.org/bot${bottoken}/sendMessage" \
        --data "chat_id=${adminid}&text=ğŸ†” <b>File ID:</b> <code>${fileId}</code>&parse_mode=html" > /dev/null
        print_success "Backup Uploaded Successfully!"
    else
        echo -e "  ${C_TOMATO}Upload Failed! Check Bot Token/ID.${C_RESET}"
    fi
    
    # Cleanup
    rm -rf /root/backup
    rm -f /root/$FILE
    
    read -n 1 -s -r -p "Press any key to return..."
    botbckpBot_menu
}

restoreBot() {
    draw_header
    if [[ ! -f /root/.bckupbot ]]; then
        echo -e "  ${C_TOMATO}Error: Bot not configured.${C_RESET}"
        sleep 2; botbckpBot_menu
    fi
    bottoken=$(sed -n '1p' /root/.bckupbot | awk '{print $1}')
    
    echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
    echo -e "${C_BURGUNDY}  |${C_RESET}                 ${C_GOLD}RESTORE PROCESS${C_RESET}                      ${C_BURGUNDY}|${C_RESET}"
    echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"
    echo -e "  ${C_CREAM}Copy the 'File ID' from your Telegram Bot.${C_RESET}"
    echo -e ""
    
    read -p "  ${ICON_DOWNLOAD} Paste File ID : " fileId
    
    print_status "Fetching File Path"
    # Get File Path from API
    GETPATH=$(curl -s "https://api.telegram.org/bot${bottoken}/getFile?file_id=${fileId}")
    filePath=$(echo $GETPATH | jq -r '.result.file_path')
    
    if [[ "$filePath" == "null" || -z "$filePath" ]]; then
        echo -e "  ${C_TOMATO}Error: Invalid File ID or API Error.${C_RESET}"
        read -n 1 -s -r -p "Press any key to return..."
        botbckpBot_menu
        exit
    fi
    
    print_status "Downloading Backup File"
    curl -s --request GET \
        --url "https://api.telegram.org/file/bot${bottoken}/${filePath}" > backup.zip
        
    read -p "  ${ICON_KEY} Input Backup Password : " InputPass
    
    print_status "Unzipping Data"
    if unzip -P "$InputPass" backup.zip &> /dev/null; then
        print_success "Unzip Successful"
    else
        echo -e "  ${C_TOMATO}Error: Wrong Password or Corrupt File.${C_RESET}"
        rm -f backup.zip
        read -n 1 -s -r -p "Return..."
        botbckpBot_menu
        exit
    fi
    
    print_status "Restoring System Files"
    cd /root/backup
    cp passwd /etc/ &> /dev/null
    cp group /etc/ &> /dev/null
    cp shadow /etc/ &> /dev/null
    cp gshadow /etc/ &> /dev/null
    
    print_status "Restoring VPS Data"
    cp -r kyt /var/lib/ &> /dev/null
    cp -r xray /etc/ &> /dev/null
    cp -r html /var/www/ &> /dev/null
    cp -r user /etc/ &> /dev/null
    
    print_status "Restoring User Data & Limits"
    # Restore Quota
    cp -r vmess/quota/* /etc/vmess/ &> /dev/null
    cp -r vless/quota/* /etc/vless/ &> /dev/null
    cp -r trojan/quota/* /etc/trojan/ &> /dev/null
    
    # Restore Limits (New Structure)
    cp -r limit/* /etc/kyt/limit/ &> /dev/null
    
    # Clean up
    cd /root
    rm -rf backup
    rm -f backup.zip
    
    print_success "Restore Completed! Services may need restart."
    read -n 1 -s -r -p "Press any key to return..."
    menu
}

autoBackup() {
    draw_header
    # Read Status (Line 3)
    switch=$(sed -n '3p' /root/.bckupbot | awk '{print $2}')
    
    if [[ "$switch" == "on" ]]; then
        # Turn OFF
        sed -i '3s/on/off/' /root/.bckupbot
        sed -i "/autobackup/d" /etc/crontab
        print_status "Disabling Auto Backup"
        service cron restart > /dev/null 2>&1
        echo -e "  ${C_TOMATO}${ICON_OFF} Auto Backup Turned OFF${C_RESET}"
    else
        # Turn ON
        sed -i '3s/off/on/' /root/.bckupbot
        echo "5 0 * * * root autobackup" >> /etc/crontab
        print_status "Enabling Auto Backup (00:05 AM)"
        service cron restart > /dev/null 2>&1
        echo -e "  ${C_SAGE}${ICON_ON} Auto Backup Turned ON${C_RESET}"
    fi
    
    sleep 2
    botbckpBot_menu
}

botbckpBot_menu() {
    # Initialize Config if not exists
    if [[ ! -f /root/.bckupbot ]]; then
        echo "null" > /root/.bckupbot
        echo "null" >> /root/.bckupbot
        echo "switch off" >> /root/.bckupbot
    fi
    
    # Read Status
    switch=$(sed -n '3p' /root/.bckupbot | awk '{print $2}')
    if [[ "$switch" == "on" ]]; then
        sts="${C_SAGE}[ON]${C_RESET}"
    else
        sts="${C_TOMATO}[OFF]${C_RESET}"
    fi

    draw_header
    echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_BOT}${C_RESET}      ${C_GOLD}TELEGRAM BACKUP AUTOMATION${C_RESET}      ${C_SAGE}${ICON_BOT}${C_RESET}        ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_CREAM}Status Auto Backup :${C_RESET} ${sts}                           ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET}                                                      ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}[1]${C_RESET} ${C_CREAM}Setup Bot Telegram${C_RESET}  ${C_GOLD}(Token/ID)${C_RESET}                 ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}[2]${C_RESET} ${C_CREAM}Toggle Auto Backup${C_RESET}  ${C_GOLD}(ON/OFF)${C_RESET}                   ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}[3]${C_RESET} ${C_CREAM}Backup VPS Now${C_RESET}      ${C_SAGE}${ICON_UPLOAD}${C_RESET}                       ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}[4]${C_RESET} ${C_CREAM}Restore From Cloud${C_RESET}  ${C_SAGE}${ICON_DOWNLOAD}${C_RESET}                       ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_TOMATO}[x]${C_RESET} ${C_TOMATO}Back to Main Menu${C_RESET}   ${C_GOLD}${ICON_EXIT}${C_RESET}                       ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    echo -e ""
    
    read -p "  Select From Options : " botch
    case "$botch" in
        1) setup_bot ;;
        2) autoBackup ;;
        3) botBackup ;;
        4) restoreBot ;;
        x|X) menu ;;
        *) botbckpBot_menu ;;
    esac
}

# Entry Point
botbckpBot_menu