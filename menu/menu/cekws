#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - VMESS MONITOR
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="ğŸ…"
ICON_USER="ğŸ‘¤"
ICON_ON="ğŸŸ¢"
ICON_OFF="ğŸ”´"
ICON_STATS="ğŸ“Š"
ICON_STAR="âœ¨"
ICON_IP="ğŸŒ"
ICON_CLOCK="â°"

# ==========================================================
#  HELPER FUNCTIONS
# ==========================================================

# Fungsi Konversi Byte
function con() {
    local -i bytes=$1;
    if [[ $bytes -lt 1024 ]]; then
        echo "${bytes} B"
    elif [[ $bytes -lt 1048576 ]]; then
        echo "$(( (bytes + 1023)/1024 )) KB"
    elif [[ $bytes -lt 1073741824 ]]; then
        echo "$(( (bytes + 1048575)/1048576 )) MB"
    else
        echo "$(( (bytes + 1073741823)/1073741824 )) GB"
    fi
}

draw_header() {
    clear
    echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_TOMATO}    ${C_TOMATO}TOMATO MONITOR${C_RESET} ${C_GOLD}(VMESS ACCOUNTS)${C_RESET}             ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR : ${C_CREAM}DUDUL (TEA V.1.0)${C_RESET}                   ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    echo -e ""
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

draw_header

# Ambil data user (Format di config: ### username exp)
data=($(grep '^###' /etc/xray/config.json | cut -d ' ' -f 2 | sort | uniq))

# Cache log untuk kecepatan (500 baris terakhir)
LOG_CONTENT=$(tail -n 500 /var/log/xray/access.log)

found_online=0

for akun in "${data[@]}"; do
    if [[ -z "$akun" ]]; then continue; fi

    # Filter log untuk user ini
    log_user=$(echo "$LOG_CONTENT" | grep -w "$akun")

    if [[ -n "$log_user" ]]; then
        # Ambil IP unik
        list_ip=$(echo "$log_user" | awk '{print $3}' | cut -d: -f1 | grep -v "127.0.0.1" | sort | uniq)
        
        # Jika ada IP (Online)
        if [[ -n "$list_ip" ]]; then
            found_online=1
            jumlah_ip=$(echo "$list_ip" | wc -l)
            lastlogin=$(echo "$log_user" | tail -n 1 | awk '{print $2}')

            # --- AMBIL INFO KUOTA & LIMIT ---
            # Path Limit IP
            if [[ -e /etc/kyt/limit/vmess/ip/${akun} ]]; then
                iplimit=$(cat /etc/kyt/limit/vmess/ip/${akun})
            else
                iplimit="None"
            fi

            # Path Quota Usage
            if [[ -e /etc/vmess/${akun} ]]; then
                byte=$(cat /etc/vmess/${akun})
                usage_fmt=$(con ${byte})
            else
                usage_fmt="0 MB"
            fi

            # Path Limit User
            if [[ -e /etc/limit/vmess/${akun} ]]; then
                limit_byte=$(cat /etc/limit/vmess/${akun})
                limit_fmt=$(con ${limit_byte})
            else
                limit_fmt="Unlimited"
            fi

            # --- CEK OVERLIMIT IP ---
            if [[ "$iplimit" != "None" && "$jumlah_ip" -gt "$iplimit" ]]; then
                ip_status="${C_TOMATO}${jumlah_ip}/${iplimit} (OVER)${C_RESET}"
            else
                ip_status="${C_SAGE}${jumlah_ip}/${iplimit}${C_RESET}"
            fi

            # --- TAMPILAN STATUS ---
            echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
            printf "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-36s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "User" "$akun"
            printf "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-36s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "Status" "${C_SAGE}ONLINE ${ICON_ON}${C_RESET}"
            echo -e "${C_BURGUNDY}â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢${C_RESET}"
            printf "${C_BURGUNDY}â•‘${C_RESET} ${C_CREAM}%-12s${C_RESET} : %-36s ${C_BURGUNDY}â•‘${C_RESET}\n" "IP Login" "$ip_status"
            printf "${C_BURGUNDY}â•‘${C_RESET} ${C_CREAM}%-12s${C_RESET} : %-36s ${C_BURGUNDY}â•‘${C_RESET}\n" "Quota" "$usage_fmt / $limit_fmt"
            printf "${C_BURGUNDY}â•‘${C_RESET} ${C_CREAM}%-12s${C_RESET} : %-36s ${C_BURGUNDY}â•‘${C_RESET}\n" "Last Login" "$lastlogin"
            echo -e "${C_BURGUNDY}â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢${C_RESET}"
            echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}Connected IP List:${C_RESET}                                   ${C_BURGUNDY}â•‘${C_RESET}"
            
            # Loop IP List
            while IFS= read -r ip; do
                if [[ -n "$ip" ]]; then
                    printf "${C_BURGUNDY}â•‘${C_RESET}   ${C_SAGE}${ICON_IP}${C_RESET} ${C_CREAM}%-46s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "$ip"
                fi
            done <<< "$list_ip"
            
            echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
            echo -e ""
        fi
    fi
done

if [[ $found_online -eq 0 ]]; then
    echo -e "${C_BURGUNDY}  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${C_RESET}"
    echo -e "  ${C_TOMATO}${ICON_OFF} No Vmess users connected at the moment.${C_RESET}"
    echo -e "${C_BURGUNDY}  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${C_RESET}"
    echo -e ""
fi

echo -e "${C_SAGE}${ICON_CLOCK} Checked at: $(date +"%H:%M:%S")${C_RESET}"
echo -e ""
read -n 1 -s -r -p "Press any key to return..."
menu