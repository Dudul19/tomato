#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - SSH & SLOWDNS CREATOR
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="🍅"
ICON_DNS="🌐"
ICON_USER="👤"
ICON_KEY="🔑"
ICON_CAL="📅"
ICON_CHECK="✔"
ICON_CROSS="✖"
ICON_STAR="✨"
ICON_TELE="✈️"

# ==========================================================
#  HELPER FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_TOMATO}    ${C_TOMATO}TOMATO MANAGER${C_RESET} ${C_GOLD}(SSH SLOWDNS)${C_RESET}              ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR : ${C_CREAM}DUDUL (TEA V.1.0)${C_RESET}                   ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
    echo -e ""
}

print_status() {
    echo -e "  ${C_GOLD}${ICON_DNS} $1...${C_RESET}"
    sleep 0.5
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

draw_header

# 1. Input Data
echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
echo -e "${C_BURGUNDY}  |${C_RESET}               ${C_GOLD}CREATE NEW ACCOUNT${C_RESET}                     ${C_BURGUNDY}|${C_RESET}"
echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"

read -p "  ${ICON_USER} Username : " Login
if [[ -z "$Login" ]]; then
    echo -e "  ${C_TOMATO}${ICON_CROSS} Cancelled. Username empty.${C_RESET}"
    sleep 1; menu; exit 0
fi

# Cek User Exists
if id "$Login" &>/dev/null; then
    echo -e "  ${C_TOMATO}${ICON_CROSS} Error: User '$Login' already exists!${C_RESET}"
    sleep 2; menu; exit 0
fi

read -p "  ${ICON_KEY} Password : " Pass
if [[ -z "$Pass" ]]; then Pass="123"; fi # Default Pass

read -p "  ${ICON_CAL} Duration (Days) : " masaaktif
if [[ -z "$masaaktif" ]]; then masaaktif="30"; fi # Default 30

# 2. Gather System Info
print_status "Gathering Server Info"
IP=$(curl -sS ipv4.icanhazip.com)
DOMAIN=$(cat /etc/xray/domain 2>/dev/null || echo "No Domain")
NS=$(cat /etc/xray/dns 2>/dev/null || echo "Not Configured")
PUB_KEY=$(cat /etc/slowdns/server.pub 2>/dev/null || echo "Not Configured")

# 3. Create User
print_status "Creating System User"
useradd -e `date -d "$masaaktif days" +"%Y-%m-%d"` -s /bin/false -M $Login
echo "$Login:$Pass" | chpasswd

# 4. Calculate Dates
TGL_BUAT=$(date +"%d %b %Y")
TGL_EXP=$(date -d "$masaaktif days" +"%d %b %Y")

# 5. Telegram Notification
# Load Config
BOT_FILE="/etc/bot/.bot.db"
if [[ -f "$BOT_FILE" ]]; then
    CHATID=$(grep -E "^#bot# " "$BOT_FILE" | cut -d ' ' -f 3)
    KEY=$(grep -E "^#bot# " "$BOT_FILE" | cut -d ' ' -f 2)
    
    if [[ ! -z "$CHATID" && ! -z "$KEY" ]]; then
        print_status "Sending Telegram Notification"
        
        MSG="
<b>🍅 TOMATO SSH SLOWDNS 🍅</b>
<code>───────────────────────</code>
<b>👤 Username :</b> <code>$Login</code>
<b>🔑 Password :</b> <code>$Pass</code>
<code>───────────────────────</code>
<b>🌐 IP Server:</b> <code>$IP</code>
<b>🐌 NS Domain:</b> <code>$NS</code>
<b>🔐 Pub Key  :</b> <code>$PUB_KEY</code>
<code>───────────────────────</code>
<b>📅 Created  :</b> $TGL_BUAT
<b>📅 Expired  :</b> $TGL_EXP
"
        curl -s --max-time 10 -d "chat_id=$CHATID&disable_web_page_preview=1&text=$MSG&parse_mode=html" "https://api.telegram.org/bot$KEY/sendMessage" >/dev/null
    fi
fi

# 6. Final Display
clear
echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_CHECK}       ${C_TOMATO}ACCOUNT CREATED SUCCESSFULLY${C_RESET}       ${C_SAGE}${ICON_DNS}${C_RESET}        ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET}                 ${C_GOLD}ACCOUNT DETAILS${C_RESET}                      ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
printf " ${C_BURGUNDY}║${C_RESET} ${C_CREAM}%-15s${C_RESET} : ${C_SAGE}%-32s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Username" "$Login"
printf " ${C_BURGUNDY}║${C_RESET} ${C_CREAM}%-15s${C_RESET} : ${C_SAGE}%-32s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Password" "$Pass"
printf " ${C_BURGUNDY}║${C_RESET} ${C_CREAM}%-15s${C_RESET} : ${C_SAGE}%-32s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Expired Date" "$TGL_EXP"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET}                 ${C_GOLD}CONNECTION INFO${C_RESET}                      ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
printf " ${C_BURGUNDY}║${C_RESET} ${C_CREAM}%-15s${C_RESET} : ${C_GOLD}%-32s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "IP Server" "$IP"
printf " ${C_BURGUNDY}║${C_RESET} ${C_CREAM}%-15s${C_RESET} : ${C_GOLD}%-32s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "NS Domain" "$NS"
printf " ${C_BURGUNDY}║${C_RESET} ${C_CREAM}%-15s${C_RESET} : ${C_GOLD}%-32s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Pub Key" "${PUB_KEY:0:30}..." 
echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"

echo -e ""
echo -e "  ${C_GOLD}Note:${C_RESET} Use NS Domain and Pub Key for SlowDNS connection."
echo -e ""
read -n 1 -s -r -p "Press any key to return..."
menu