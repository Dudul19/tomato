#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - SSL MANAGER
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="ğŸ…"
ICON_LOCK="ğŸ”’"
ICON_KEY="ğŸ”‘"
ICON_GLOBE="ğŸŒ"
ICON_CHECK="âœ”"
ICON_CROSS="âœ–"
ICON_GEAR="âš™"
ICON_STAR="âœ¨"

# ==========================================================
#  HELPER FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_TOMATO}    ${C_TOMATO}TOMATO SECURITY${C_RESET} ${C_GOLD}(SSL MANAGER)${C_RESET}              ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR : ${C_CREAM}DUDUL (TEA V.1.0)${C_RESET}                   ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    echo -e ""
}

print_status() {
    echo -e "  ${C_GOLD}${ICON_GEAR} $1...${C_RESET}"
    sleep 0.5
}

print_success() {
    echo -e "  ${C_SAGE}${ICON_CHECK} SUCCESS:${C_RESET} ${C_CREAM}$1${C_RESET}"
    sleep 0.5
}

print_error() {
    echo -e "  ${C_TOMATO}${ICON_CROSS} ERROR:${C_RESET} ${C_CREAM}$1${C_RESET}"
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

draw_header

# 1. Check Domain
domain=$(cat /etc/xray/domain 2>/dev/null)
if [[ -z "$domain" ]]; then
    print_error "Domain configuration not found!"
    exit 1
fi

echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
echo -e "${C_BURGUNDY}  |${C_RESET}                  ${C_GOLD}SSL CONFIGURATION${C_RESET}                   ${C_BURGUNDY}|${C_RESET}"
echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"
echo -e "   ${C_SAGE}${ICON_GLOBE} Domain :${C_RESET} ${C_CREAM}$domain${C_RESET}"
echo -e "${C_BURGUNDY}  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${C_RESET}"
echo -e ""

# 2. Stop Services
print_status "Stopping Web Services (Port 80)"
systemctl stop nginx
systemctl stop xray
systemctl stop haproxy

# Kill any lingering process on port 80
pid_port_80=$(lsof -t -i:80)
if [[ ! -z "$pid_port_80" ]]; then
    kill -9 $pid_port_80 > /dev/null 2>&1
fi

# 3. Clean Old Certs & Acme
print_status "Cleaning Old Certificates"
rm -rf /etc/xray/xray.key
rm -rf /etc/xray/xray.crt
rm -rf /root/.acme.sh

# 4. Install Acme.sh
print_status "Installing Acme.sh Protocol"
mkdir /root/.acme.sh
curl -s https://acme-install.netlify.app/acme.sh -o /root/.acme.sh/acme.sh
chmod +x /root/.acme.sh/acme.sh
/root/.acme.sh/acme.sh --upgrade --auto-upgrade >/dev/null 2>&1
/root/.acme.sh/acme.sh --set-default-ca --server letsencrypt >/dev/null 2>&1

# 5. Issue Certificate
print_status "Requesting New SSL Certificate"
if /root/.acme.sh/acme.sh --issue -d $domain --standalone -k ec-256 --force; then
    print_success "Certificate Issued Successfully"
    
    # 6. Install Certificate
    print_status "Installing to /etc/xray"
    /root/.acme.sh/acme.sh --installcert -d $domain \
        --fullchainpath /etc/xray/xray.crt \
        --keypath /etc/xray/xray.key \
        --ecc >/dev/null 2>&1
        
    chmod 644 /etc/xray/xray.key
    status_ssl="Success"
else
    print_error "Failed to Issue Certificate"
    status_ssl="Failed"
fi

# 7. Restart Services
print_status "Restarting System Services"
systemctl restart nginx
systemctl restart xray
systemctl restart haproxy

# ==========================================================
#  TELEGRAM NOTIFICATION
# ==========================================================
CHATID=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3)
KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 2)
TIME="10"
URL="https://api.telegram.org/bot$KEY/sendMessage"

if [[ ! -z "$CHATID" && ! -z "$KEY" ]]; then
    TEXT="
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>  ğŸ… SSL RENEWAL REPORT ğŸ…</b>
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>Domain   :</b> <code>$domain</code>
<b>Status   :</b> <code>$status_ssl</code>
<b>Date     :</b> <code>$(date +"%d %b %Y %H:%M")</code>
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<code>Automated by Tomato Autoscript</code>
"
    curl -s --max-time $TIME -d "chat_id=$CHATID&disable_web_page_preview=1&text=$TEXT&parse_mode=html" $URL >/dev/null
fi

# ==========================================================
#  FINAL OUTPUT
# ==========================================================
clear
echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_CHECK}       ${C_TOMATO}SSL SETUP COMPLETED SUCCESSFULLY${C_RESET}       ${C_SAGE}${ICON_LOCK}${C_RESET}        ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
printf " ${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "Domain" "$domain"
printf " ${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "Status" "Active (HTTPS)"
printf " ${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "Location" "/etc/xray/"
echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"

echo -e ""
read -n 1 -s -r -p "Press any key to return..."
menu