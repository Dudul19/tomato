#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - DOMAIN MANAGER
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="ğŸ…"
ICON_STAR="âœ¨"
ICON_ARROW="âœ"
ICON_CHECK="âœ”"
ICON_CROSS="âœ–"
ICON_GEAR="âš™"
ICON_LOCK="ğŸ”’"
ICON_GLOBE="ğŸŒ"

# ==========================================================
#  PERMISSION CHECK
# ==========================================================
clear
echo -e "${C_SAGE}${ICON_GEAR} Checking Permission...${C_RESET}"

MYIP=$(curl -sS ipv4.icanhazip.com)
data_ip="https://raw.githubusercontent.com/dudul19/tomato/main/izin"
useexp=$(wget -qO- $data_ip | grep $MYIP | awk '{print $3}')
today=$(date +"%Y-%m-%d")

if [[ "$today" > "$useexp" ]]; then
    echo -e ""
    echo -e " ${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e " ${C_BURGUNDY}â•‘${C_RESET}       ${C_TOMATO}${ICON_CROSS}  404 NOT FOUND AUTOSCRIPT  ${ICON_CROSS}${C_RESET}         ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e " ${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
    echo -e " ${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}Status :${C_RESET} ${C_TOMATO}PERMISSION DENIED${C_RESET}                           ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e " ${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}IP     :${C_RESET} ${C_CREAM}$MYIP${C_RESET}                           ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e " ${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}Info   :${C_RESET} ${C_CREAM}Your VPS Has been Banned${C_RESET}               ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e " ${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}Contact:${C_RESET} ${C_SAGE}t.me/dudulrealnofek${C_RESET}                    ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e " ${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    exit 0
fi

# ==========================================================
#  HELPER FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_TOMATO}    ${C_TOMATO}TOMATO DOMAIN MANAGER${C_RESET} ${C_GOLD}(SSL/TLS)${C_RESET}           ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR : ${C_CREAM}DUDUL (TEA V.1.0)${C_RESET}                   ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    echo -e ""
}

print_status() {
    echo -e "  ${C_GOLD}${ICON_GEAR} $1...${C_RESET}"
    sleep 1
}

print_success() {
    echo -e "  ${C_SAGE}${ICON_CHECK} SUCCESS:${C_RESET} ${C_CREAM}$1${C_RESET}"
    sleep 1
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

function pasang_domain() {
    draw_header
    echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
    echo -e "${C_BURGUNDY}  |${C_RESET}               ${C_GOLD}IMPORTANT NOTICE${C_RESET}                     ${C_BURGUNDY}|${C_RESET}"
    echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"
    echo -e "  ${C_SAGE}${ICON_ARROW} Please point your domain to IP:${C_RESET} ${C_CREAM}$MYIP${C_RESET}"
    echo -e "  ${C_SAGE}${ICON_ARROW} Before proceeding with SSL installation.${C_RESET}"
    echo -e "${C_BURGUNDY}  ------------------------------------------------------${C_RESET}"
    echo -e ""
    
    echo -e "  ${C_GOLD}[?] Input your new domain :${C_RESET}"
    read -p "      > " -e pp

    if [ -z "$pp" ]; then
        echo -e "  ${C_TOMATO}${ICON_CROSS} Error: No domain input.${C_RESET}"
        return 1
    else
        echo "$pp" > /etc/xray/domain
        echo "$pp" > /root/domain
        echo "IP=$pp" > /var/lib/kyt/ipvps.conf
        print_success "Domain updated to: $pp"
    fi
}

function pasang_ssl() {
    echo -e ""
    print_status "Starting ACME SSL Installation"
    
    # Clean old certs
    rm -rf /etc/xray/xray.key
    rm -rf /etc/xray/xray.crt
    domain=$(cat /etc/xray/domain)
    
    # Stop services to free up port 80
    STOPWEBSERVER=$(lsof -i:80 | cut -d' ' -f1 | awk 'NR==2 {print $1}')
    if [[ ! -z "$STOPWEBSERVER" ]]; then
        systemctl stop $STOPWEBSERVER
    fi
    systemctl stop nginx
    systemctl stop haproxy

    # Install ACME
    rm -rf /root/.acme.sh
    mkdir /root/.acme.sh
    curl https://acme-install.netlify.app/acme.sh -o /root/.acme.sh/acme.sh
    chmod +x /root/.acme.sh/acme.sh
    /root/.acme.sh/acme.sh --upgrade --auto-upgrade >/dev/null 2>&1
    /root/.acme.sh/acme.sh --set-default-ca --server letsencrypt >/dev/null 2>&1
    
    # Issue Cert
    print_status "Requesting Certificate for $domain"
    /root/.acme.sh/acme.sh --issue -d $domain --standalone -k ec-256
    ~/.acme.sh/acme.sh --installcert -d $domain --fullchainpath /etc/xray/xray.crt --keypath /etc/xray/xray.key --ecc
    
    chmod 777 /etc/xray/xray.key
    
    # Restart Services
    systemctl restart nginx
    systemctl restart xray
    systemctl restart haproxy
    
    if [ -f /etc/xray/xray.key ]; then
        print_success "SSL Certificate Installed Successfully"
    else
        echo -e "  ${C_TOMATO}${ICON_CROSS} Error: SSL Installation Failed.${C_RESET}"
    fi
}

function notif_addhost() {
    CHATID=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3)
    KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 2)
    TIME="10"
    URL="https://api.telegram.org/bot$KEY/sendMessage"
    
    if [[ ! -z "$CHATID" && ! -z "$KEY" ]]; then
        print_status "Sending Telegram Notification"
        TEXT="
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>    âš ï¸ ADDHOST NOTIF âš ï¸</b>
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>IP VPS  :</b> <code>$MYIP</code>
<b>DOMAIN  :</b> <code>$pp</code>
<b>STATUS  :</b> <code>SSL INSTALLED</code>
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<code>BY TOMATO AUTOSCRIPT</code>
"
        curl -s --max-time $TIME -d "chat_id=$CHATID&disable_web_page_preview=1&text=$TEXT&parse_mode=html" $URL >/dev/null
    fi
}

# --- EXECUTION ---
pasang_domain
if [[ ! -z "$pp" ]]; then
    pasang_ssl
    notif_addhost
fi

echo -e ""
echo -e "  ${C_GOLD}${ICON_ARROW} Back to menu in 2 seconds...${C_RESET}"
sleep 2
menu