#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - TROJAN CREATOR
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="🍅"
ICON_STAR="✨"
ICON_USER="👤"
ICON_SHIELD="🛡️"
ICON_GLOBE="🌐"
ICON_CHECK="✔"
ICON_CROSS="✖"
ICON_GEAR="⚙"
ICON_ROCKET="🚀"

# ==========================================================
#  PERMISSION CHECK
# ==========================================================
clear
MYIP=$(curl -sS ipv4.icanhazip.com)
data_ip="https://raw.githubusercontent.com/dudul19/tomato/main/izin"
useexp=$(wget -qO- $data_ip | grep $MYIP | awk '{print $3}')
today=$(date +"%Y-%m-%d")

if [[ "$today" > "$useexp" ]]; then
    echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET}       ${C_TOMATO}${ICON_CROSS}  404 NOT FOUND AUTOSCRIPT  ${ICON_CROSS}${C_RESET}         ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}Status :${C_RESET} ${C_TOMATO}PERMISSION DENIED${C_RESET}                           ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}IP     :${C_RESET} ${C_CREAM}$MYIP${C_RESET}                           ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}Info   :${C_RESET} ${C_CREAM}Your VPS Has been Banned${C_RESET}               ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
    exit 0
fi

# ==========================================================
#  HELPER FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_TOMATO}     ${C_TOMATO}TOMATO TROJAN${C_RESET} ${C_GOLD}(WS/GRPC)${C_RESET}                  ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR : ${C_CREAM}DUDUL (TEA V.1.0)${C_RESET}                   ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
    echo -e ""
}

print_status() {
    echo -e "  ${C_GOLD}${ICON_GEAR} $1...${C_RESET}"
    sleep 0.5
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

# Load Configs
source /var/lib/kyt/ipvps.conf
if [[ "$IP" = "" ]]; then
    domain=$(cat /etc/xray/domain)
else
    domain=$IP
fi

# Load ISP Info
ISP=$(cat /root/.info/.isp 2>/dev/null)
CITY=$(cat /root/.info/.city 2>/dev/null)
NS=$(cat /etc/xray/dns 2>/dev/null)

# Input User Loop
while true; do
    draw_header
    echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
    echo -e "${C_BURGUNDY}  |${C_RESET}                 ${C_GOLD}CREATE NEW ACCOUNT${C_RESET}                 ${C_BURGUNDY}|${C_RESET}"
    echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"
    echo -e ""
    
    echo -e "  ${C_GOLD}[?] Username :${C_RESET}"
    read -p "      > " -e user

    # Validasi Input
    if [[ -z "$user" ]]; then
        echo -e "  ${C_TOMATO}${ICON_CROSS} Error: Username cannot be empty.${C_RESET}"
        sleep 1
        continue
    fi
    if [[ ! $user =~ ^[a-zA-Z0-9_]+$ ]]; then
        echo -e "  ${C_TOMATO}${ICON_CROSS} Error: Use alphanumeric characters only.${C_RESET}"
        sleep 1
        continue
    fi

    # Cek User Exist
    CLIENT_EXISTS=$(grep -w $user /etc/xray/config.json | wc -l)
    if [[ ${CLIENT_EXISTS} == '1' ]]; then
        echo -e "  ${C_TOMATO}${ICON_CROSS} Error: User '$user' already exists.${C_RESET}"
        sleep 1
    else
        break
    fi
done

echo -e ""
echo -e "  ${C_GOLD}[?] Expired (Days) :${C_RESET}"
read -p "      > " masaaktif
echo -e ""
echo -e "  ${C_GOLD}[?] Quota Limit (GB) :${C_RESET}"
read -p "      > " Quota
echo -e ""
echo -e "  ${C_GOLD}[?] IP Limit :${C_RESET}"
read -p "      > " iplimit

# Processing
print_status "Generating UUID & Configs"

uuid=$(cat /proc/sys/kernel/random/uuid)

# Date Calculation
tgl=$(date -d "$masaaktif days" +"%d")
bln=$(date -d "$masaaktif days" +"%b")
thn=$(date -d "$masaaktif days" +"%Y")
expe="$tgl $bln, $thn"
tgl2=$(date +"%d")
bln2=$(date +"%b")
thn2=$(date +"%Y")
tnggl="$tgl2 $bln2, $thn2"
exp=`date -d "$masaaktif days" +"%Y-%m-%d"`

# Inject Xray Config
sed -i '/#trojanws$/a\#! '"$user $exp"'\
},{"password": "'""$uuid""'","email": "'""$user""'"' /etc/xray/config.json
sed -i '/#trojangrpc$/a\#! '"$user $exp"'\
},{"password": "'""$uuid""'","email": "'""$user""'"' /etc/xray/config.json

# Generate Links
trojanlink1="trojan://${uuid}@${domain}:443?mode=gun&security=tls&type=grpc&serviceName=trojan-grpc&sni=${domain}#${user}"
trojanlink="trojan://${uuid}@${domain}:443?path=%2Ftrojan-ws&security=tls&host=${domain}&type=ws&sni=${domain}#${user}"

# Restart Service
print_status "Restarting Services"
systemctl reload xray
systemctl reload nginx
service cron restart

# Handling Quota & IP Limit
if [ ! -e /etc/trojan ]; then mkdir -p /etc/trojan; fi

# IP Limit (Standardized to /etc/kyt)
if [[ $iplimit -gt 0 ]]; then
    mkdir -p /etc/kyt/limit/trojan/ip
    echo -e "$iplimit" > /etc/kyt/limit/trojan/ip/$user
fi

# Quota Limit
if [ -z ${Quota} ]; then Quota="0"; fi
c=$(echo "${Quota}" | sed 's/[^0-9]*//g')
d=$((${c} * 1024 * 1024 * 1024))
if [[ ${c} != "0" ]]; then
    echo "${d}" >/etc/trojan/${user}
fi

# Update Database
DATADB=$(cat /etc/trojan/.trojan.db | grep "^###" | grep -w "${user}" | awk '{print $2}')
if [[ "${DATADB}" != '' ]]; then
    sed -i "/\b${user}\b/d" /etc/trojan/.trojan.db
fi
echo "### ${user} ${exp} ${uuid} ${Quota} ${iplimit}" >>/etc/trojan/.trojan.db

# Client File (OpenClash)
cat >/var/www/html/trojan-$user.txt <<-END
◇━━━━━━━━━━━━━━━━━◇
    Format For Clash
◇━━━━━━━━━━━━━━━━━◇

# Format Trojan GO/WS
- name: Trojan-$user-GO/WS
  server: ${domain}
  port: 443
  type: trojan
  password: ${uuid}
  network: ws
  sni: ${domain}
  skip-cert-verify: true
  udp: true
  ws-opts:
    path: /trojan-ws
    headers:
        Host: ${domain}

# Format Trojan gRPC
- name: Trojan-$user-gRPC
  type: trojan
  server: ${domain}
  port: 443
  password: ${uuid}
  udp: true
  sni: ${domain}
  skip-cert-verify: true
  network: grpc
  grpc-opts:
    grpc-service-name: trojan-grpc
END

# ==========================================================
#  TELEGRAM NOTIFICATION
# ==========================================================
CHATID=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3)
KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 2)
TIME="10"
URL="https://api.telegram.org/bot$KEY/sendMessage"

if [[ ! -z "$CHATID" && ! -z "$KEY" ]]; then
TEXT="
<code>◇━━━━━━━━━━━━━━━━━━━━━━◇</code>
<b>  🍅 TROJAN ACCOUNT 🍅</b>
<code>◇━━━━━━━━━━━━━━━━━━━━━━◇</code>
<b>User     :</b> <code>$user</code>
<b>Expired  :</b> <code>$expe</code>
<b>Quota    :</b> <code>${Quota} GB</code>
<b>IP Limit :</b> <code>${iplimit}</code>
<b>Domain   :</b> <code>$domain</code>
<code>◇━━━━━━━━━━━━━━━━━━━━━━◇</code>
<b>Trojan WS :</b> 
<code>$trojanlink</code>
<code>◇━━━━━━━━━━━━━━━━━━━━━━◇</code>
<b>Trojan gRPC :</b> 
<code>$trojanlink1</code>
<code>◇━━━━━━━━━━━━━━━━━━━━━━◇</code>
"
curl -s --max-time $TIME -d "chat_id=$CHATID&disable_web_page_preview=1&text=$TEXT&parse_mode=html" $URL >/dev/null
fi

# ==========================================================
#  FINAL OUTPUT
# ==========================================================
# Log internal
echo -e "User: $user | Exp: $expe | Q: ${Quota}GB" >> /etc/user-create/user.log

clear
echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_CHECK}    ${C_TOMATO}ACCOUNT CREATED SUCCESSFULLY${C_RESET}     ${C_SAGE}${ICON_ROCKET}${C_RESET}        ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
# Info
printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Username" "$user"
printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Password" "$uuid"
printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Expired" "$expe"
printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Quota" "${Quota} GB"
printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "IP Limit" "$iplimit Device"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
# Path Info
echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_GEAR} CONFIGURATION INFO${C_RESET}                                 ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_CREAM}Path WS: /trojan-ws${C_RESET}                                  ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_CREAM}Service: trojan-grpc${C_RESET}                                 ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
# Links
echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_GLOBE} TROJAN WS TLS${C_RESET}                                     ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_CREAM}${trojanlink}${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_GLOBE} TROJAN GRPC${C_RESET}                                       ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_CREAM}${trojanlink1}${C_RESET}"
echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"

echo -e ""
read -n 1 -s -r -p "Press any key to back on menu"
menu