#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - DELETE VLESS
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="🍅"
ICON_TRASH="🗑️"
ICON_USER="👤"
ICON_CHECK="✔"
ICON_CROSS="✖"
ICON_GEAR="⚙"
ICON_STAR="✨"

# ==========================================================
#  HELPER FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_TOMATO}    ${C_TOMATO}TOMATO MANAGER${C_RESET} ${C_GOLD}(DELETE VLESS)${C_RESET}             ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR : ${C_CREAM}DUDUL (TEA V.1.0)${C_RESET}                   ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
    echo -e ""
}

print_status() {
    echo -e "  ${C_GOLD}${ICON_GEAR} $1...${C_RESET}"
    sleep 0.5
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

draw_header

# 1. Check Clients
# Format VLESS di script ini menggunakan marker: #&
NUMBER_OF_CLIENTS=$(grep -c -E "^#& " "/etc/xray/config.json")

if [[ ${NUMBER_OF_CLIENTS} == '0' ]]; then
    echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
    echo -e "${C_BURGUNDY}  |${C_RESET}                 ${C_TOMATO}NO DATA FOUND${C_RESET}                      ${C_BURGUNDY}|${C_RESET}"
    echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"
    echo -e ""
    echo -e "  ${C_TOMATO}${ICON_CROSS} You have no existing VLESS clients.${C_RESET}"
    echo -e ""
    echo -e "${C_BURGUNDY}  ──────────────────────────────────────────────────────${C_RESET}"
    read -n 1 -s -r -p "  Press any key to return..."
    m-vless
    exit 0
fi

# 2. List Clients
echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
echo -e "${C_BURGUNDY}  |${C_RESET}               ${C_GOLD}REGISTERED USERS${C_RESET}                     ${C_BURGUNDY}|${C_RESET}"
echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"

# Loop user list for nice formatting
grep -E "^#& " "/etc/xray/config.json" | cut -d ' ' -f 2-3 | while read -r user exp; do
    printf "  ${C_CREAM}%-25s${C_RESET} ${C_SAGE}%-20s${C_RESET}\n" "$user" "$exp"
done

echo -e "${C_BURGUNDY}  ──────────────────────────────────────────────────────${C_RESET}"
echo -e ""

# 3. Input User
echo -e "  ${C_GOLD}[?] Input Username to Delete :${C_RESET}"
read -p "      > " user

# Validation
if [[ -z "$user" ]]; then
    echo -e "  ${C_TOMATO}${ICON_CROSS} Error: Input cannot be empty.${C_RESET}"
    sleep 1
    m-vless
    exit 0
fi

# Cek apakah user ada di config
if ! grep -q "^#& $user" "/etc/xray/config.json"; then
    echo -e "  ${C_TOMATO}${ICON_CROSS} Error: User '$user' not found.${C_RESET}"
    sleep 1
    m-vless
    exit 0
fi

# 4. Processing Deletion
print_status "Removing Account"

# Ambil tanggal expired user tsb untuk pattern sed
exp=$(grep -wE "^#& $user" "/etc/xray/config.json" | cut -d ' ' -f 3 | head -1)

# Hapus dari config Xray (Pattern: #& user exp ... sampai ... },)
sed -i "/^#& $user $exp/,/^},{/d" /etc/xray/config.json

# Hapus dari Database Vless (Standardize cleanup)
sed -i "/^### $user /d" /etc/vless/.vless.db
sed -i "/^#& $user /d" /etc/vless/.vless.db

# Hapus file limit & quota (Cleanup)
# Menggunakan path /etc/kyt agar standar
rm -f /etc/kyt/limit/vless/ip/$user
rm -f /etc/vless/$user

# Restart Service
print_status "Restarting Xray Service"
systemctl restart xray > /dev/null 2>&1

# 5. Success Output
clear
echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_TOMATO}${ICON_TRASH}       ${C_GOLD}ACCOUNT DELETED SUCCESSFULLY${C_RESET}       ${C_TOMATO}${ICON_TRASH}${C_RESET}        ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Username" "$user"
printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Expired" "$exp"
printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Status" "Deleted"
echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"

echo -e ""
read -n 1 -s -r -p "Press any key to return..."
m-vless