#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - SHADOWSOCKS CREATOR
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="ğŸ…"
ICON_STAR="âœ¨"
ICON_USER="ğŸ‘¤"
ICON_LOCK="ğŸ”’"
ICON_GLOBE="ğŸŒ"
ICON_CHECK="âœ”"
ICON_CROSS="âœ–"
ICON_GEAR="âš™"
ICON_ROCKET="ğŸš€"

# ==========================================================
#  PERMISSION CHECK
# ==========================================================
clear
MYIP=$(curl -sS ipv4.icanhazip.com)
data_ip="https://raw.githubusercontent.com/dudul19/tomato/main/izin"
useexp=$(wget -qO- $data_ip | grep $MYIP | awk '{print $3}')
today=$(date +"%Y-%m-%d")

if [[ "$today" > "$useexp" ]]; then
    echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET}       ${C_TOMATO}${ICON_CROSS}  404 NOT FOUND AUTOSCRIPT  ${ICON_CROSS}${C_RESET}         ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}Status :${C_RESET} ${C_TOMATO}PERMISSION DENIED${C_RESET}                           ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}IP     :${C_RESET} ${C_CREAM}$MYIP${C_RESET}                           ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}Info   :${C_RESET} ${C_CREAM}Your VPS Has been Banned${C_RESET}               ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    exit 0
fi

# ==========================================================
#  HELPER FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_TOMATO}    ${C_TOMATO}TOMATO SHADOWSOCKS${C_RESET} ${C_GOLD}(WS/GRPC)${C_RESET}               ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR : ${C_CREAM}DUDUL (TEA V.1.0)${C_RESET}                   ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    echo -e ""
}

print_status() {
    echo -e "  ${C_GOLD}${ICON_GEAR} $1...${C_RESET}"
    sleep 0.5
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

# Load Domain & Config
source /var/lib/kyt/ipvps.conf
if [[ "$IP" = "" ]]; then
    domain=$(cat /etc/xray/domain)
else
    domain=$IP
fi

# Input User Loop
while true; do
    draw_header
    echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
    echo -e "${C_BURGUNDY}  |${C_RESET}                 ${C_GOLD}CREATE NEW ACCOUNT${C_RESET}                 ${C_BURGUNDY}|${C_RESET}"
    echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"
    echo -e ""
    
    echo -e "  ${C_GOLD}[?] Input Username :${C_RESET}"
    read -p "      > " -e user

    # Validasi Input
    if [[ -z "$user" ]]; then
        echo -e "  ${C_TOMATO}${ICON_CROSS} Error: Username cannot be empty.${C_RESET}"
        sleep 1
        continue
    fi
    if [[ ! $user =~ ^[a-zA-Z0-9_]+$ ]]; then
        echo -e "  ${C_TOMATO}${ICON_CROSS} Error: Use alphanumeric characters only.${C_RESET}"
        sleep 1
        continue
    fi

    # Cek User Exist
    CLIENT_EXISTS=$(grep -w $user /etc/xray/config.json | wc -l)
    if [[ ${CLIENT_EXISTS} == '1' ]]; then
        echo -e "  ${C_TOMATO}${ICON_CROSS} Error: User '$user' already exists.${C_RESET}"
        sleep 1
    else
        break
    fi
done

echo -e ""
echo -e "  ${C_GOLD}[?] Expired (Days) :${C_RESET}"
read -p "      > " masaaktif
echo -e ""
echo -e "  ${C_GOLD}[?] Quota Limit (GB) :${C_RESET}"
read -p "      > " Quota

# Processing
print_status "Generating UUID & Configs"

cipher="aes-128-gcm"
uuid=$(cat /proc/sys/kernel/random/uuid)

# Date Calculation
tgl=$(date -d "$masaaktif days" +"%d")
bln=$(date -d "$masaaktif days" +"%b")
thn=$(date -d "$masaaktif days" +"%Y")
expe="$tgl $bln, $thn"
tgl2=$(date +"%d")
bln2=$(date +"%b")
thn2=$(date +"%Y")
tnggl="$tgl2 $bln2, $thn2"
exp=`date -d "$masaaktif days" +"%Y-%m-%d"`

# Inject Xray Config
sed -i '/#ssws$/a\#!# '"$user $exp"'\
},{"password": "'""$uuid""'","method": "'""$cipher""'","email": "'""$user""'"' /etc/xray/config.json
sed -i '/#ssgrpc$/a\#!# '"$user $exp"'\
},{"password": "'""$uuid""'","method": "'""$cipher""'","email": "'""$user""'"' /etc/xray/config.json

# Generate Links
echo $cipher:$uuid > /tmp/log
shadowsocks_base64=$(cat /tmp/log)
echo -n "${shadowsocks_base64}" | base64 > /tmp/log1
shadowsocks_base64e=$(cat /tmp/log1)
shadowsockslink="ss://${shadowsocks_base64e}@$domain:$tls?plugin=xray-plugin;mux=0;path=/ss-ws;host=$domain;tls#${user}"
shadowsockslink1="ss://${shadowsocks_base64e}@$domain:$tls?plugin=xray-plugin;mux=0;serviceName=ss-grpc;host=$domain;tls#${user}"

# Links Display
sslinkws="ss://${shadowsocks_base64e}@${domain}:443?path=/ss-ws&security=tls&encryption=none&type=ws#${user}"
nonsslinkws="ss://${shadowsocks_base64e}@${domain}:80?path=/ss-ws&security=none&encryption=none&type=ws#${user}"
sslinkgrpc="ss://${shadowsocks_base64e}@${domain}:443?mode=gun&security=tls&encryption=none&type=grpc&serviceName=ss-grpc&sni=bug.com#${user}"
nonsslinkgrpc="ss://${shadowsocks_base64e}@${domain}:80?mode=gun&security=none&encryption=none&type=grpc&serviceName=ss-grpc&sni=bug.com#${user}"

# Restart Service
print_status "Restarting Xray Service"
systemctl restart xray
rm -rf /tmp/log
rm -rf /tmp/log1

# Client JSON Generation (Keeping your original logic for client files)
cat > /var/www/html/sodosokws-$user.txt <<-END
{ 
 "dns": { "servers": [ "8.8.8.8", "8.8.4.4" ] },
 "inbounds": [
   { "port": 10808, "protocol": "socks", "settings": { "auth": "noauth", "udp": true, "userLevel": 8 }, "tag": "socks" },
   { "port": 10809, "protocol": "http", "settings": { "userLevel": 8 }, "tag": "http" }
 ],
 "outbounds": [
   { "protocol": "shadowsocks", "settings": { "servers": [ { "address": "$domain", "level": 8, "method": "$cipher", "password": "$uuid", "port": 443 } ] }, "streamSettings": { "network": "ws", "security": "tls", "tlsSettings": { "allowInsecure": true, "serverName": "isi_bug_disini" }, "wsSettings": { "headers": { "Host": "$domain" }, "path": "/ss-ws" } }, "tag": "proxy" }
 ]
}
END

# Handling Quota Database
if [ -z ${Quota} ]; then Quota="0"; fi
c=$(echo "${Quota}" | sed 's/[^0-9]*//g')
d=$((${c} * 1024 * 1024 * 1024))
if [[ ${c} != "0" ]]; then
  if [ ! -e /etc/shadowsocks ]; then mkdir -p /etc/shadowsocks; fi
  echo "${d}" >/etc/shadowsocks/${user}
fi

# Update Database
DATADB=$(cat /etc/shadowsocks/.shadowsocks.db | grep "^###" | grep -w "${user}" | awk '{print $2}')
if [[ "${DATADB}" != '' ]]; then
  sed -i "/\b${user}\b/d" /etc/shadowsocks/.shadowsocks.db
fi
echo "### ${user} ${exp} ${uuid}" >>/etc/shadowsocks/.shadowsocks.db

# ==========================================================
#  TELEGRAM NOTIFICATION
# ==========================================================
CHATID=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3)
KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 2)
TIME="10"
URL="https://api.telegram.org/bot$KEY/sendMessage"

if [[ ! -z "$CHATID" && ! -z "$KEY" ]]; then
TEXT="
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>  ğŸ… SHADOWSOCKS CREATED ğŸ…</b>
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>User    :</b> <code>$user</code>
<b>Expired :</b> <code>$expe</code>
<b>Quota   :</b> <code>${Quota} GB</code>
<b>Domain  :</b> <code>$domain</code>
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>Link WS :</b> <code>$sslinkws</code>
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>Link GRPC :</b> <code>$sslinkgrpc</code>
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
"
curl -s --max-time $TIME -d "chat_id=$CHATID&disable_web_page_preview=1&text=$TEXT&parse_mode=html" $URL >/dev/null
fi

# ==========================================================
#  FINAL OUTPUT
# ==========================================================
clear
echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_CHECK}    ${C_TOMATO}ACCOUNT CREATED SUCCESSFULLY${C_RESET}     ${C_SAGE}${ICON_ROCKET}${C_RESET}        ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
# Info
printf " ${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "Username" "$user"
printf " ${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "Password" "$uuid"
printf " ${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "Expired" "$expe"
printf " ${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "Quota" "${Quota} GB"
printf " ${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "Method" "$cipher"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
# Links
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_GLOBE} SHADOWSOCKS WS TLS${C_RESET}                                ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_CREAM}${sslinkws}${C_RESET}"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_GLOBE} SHADOWSOCKS WS NON-TLS${C_RESET}                            ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_CREAM}${nonsslinkws}${C_RESET}"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_GLOBE} SHADOWSOCKS GRPC${C_RESET}                                  ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_CREAM}${sslinkgrpc}${C_RESET}"
echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"

# Log to internal file
echo -e "User: $user | Exp: $expe | Q: $Quota" >> /etc/user-create/user.log

echo -e ""
read -n 1 -s -r -p "Press any key to back on menu"
menu