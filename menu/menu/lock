#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - LOCK ACCOUNT
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="ğŸ…"
ICON_LOCK="ğŸ”’"
ICON_UNLOCK="ğŸ”“"
ICON_USER="ğŸ‘¤"
ICON_CHECK="âœ”"
ICON_CROSS="âœ–"
ICON_GEAR="âš™"
ICON_STAR="âœ¨"
ICON_WARN="âš ï¸"

# ==========================================================
#  HELPER FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_TOMATO}    ${C_TOMATO}TOMATO MANAGER${C_RESET} ${C_GOLD}(LOCK SSH USER)${C_RESET}            ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR : ${C_CREAM}DUDUL (TEA V.1.0)${C_RESET}                   ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    echo -e ""
}

print_status() {
    echo -e "  ${C_GOLD}${ICON_GEAR} $1...${C_RESET}"
    sleep 0.5
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

draw_header

# 1. LIST USERS
echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
echo -e "${C_BURGUNDY}  |${C_RESET}               ${C_GOLD}REGISTERED SSH USERS${C_RESET}                 ${C_BURGUNDY}|${C_RESET}"
echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"
printf "  ${C_GOLD}%-18s %-16s %-12s${C_RESET}\n" "USERNAME" "EXPIRY" "STATUS"
echo -e "${C_BURGUNDY}  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${C_RESET}"

count=0
# Loop /etc/passwd directly
while IFS=: read -r username _ uid _ _ _ _; do
    # Filter UID >= 1000, bukan root, bukan nobody
    if [[ $uid -ge 1000 && "$username" != "nobody" ]]; then
        # Cek Expired
        exp_date=$(chage -l "$username" | grep "Account expires" | awk -F": " '{print $2}')
        if [[ -z "$exp_date" || "$exp_date" == "never" ]]; then exp_date="Never"; fi
        
        # Cek Status Lock (L = Locked, P = Password set/Active)
        status_code=$(passwd -S "$username" | awk '{print $2}')
        if [[ "$status_code" == "L" ]]; then
            status_display="${C_TOMATO}LOCKED ${ICON_LOCK}${C_RESET}"
        else
            status_display="${C_SAGE}ACTIVE ${ICON_UNLOCK}${C_RESET}"
        fi
        
        printf "  ${C_CREAM}%-18s${C_RESET} ${C_SAGE}%-16s${C_RESET} %-12s\n" "$username" "$exp_date" "$status_display"
        ((count++))
    fi
done < /etc/passwd

if [[ $count -eq 0 ]]; then
    echo -e "  ${C_TOMATO}${ICON_CROSS} No SSH users found.${C_RESET}"
fi
echo -e "${C_BURGUNDY}  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${C_RESET}"
echo -e ""

# 2. INPUT USER
echo -e "  ${C_GOLD}[?] Input Username to Lock :${C_RESET}"
read -p "      > " user

# Validasi Input
if [[ -z "$user" ]]; then
    echo -e "  ${C_TOMATO}${ICON_CROSS} Error: Input cannot be empty.${C_RESET}"
    sleep 1
    menu
    exit 0
fi

# Validasi Existence
if ! getent passwd "$user" > /dev/null 2>&1; then
    echo -e "  ${C_TOMATO}${ICON_CROSS} Error: User '$user' not found.${C_RESET}"
    sleep 1
    menu
    exit 0
fi

# Validasi Root
if [[ "$user" == "root" ]]; then
    echo -e "  ${C_TOMATO}${ICON_WARN} Error: Cannot lock root user!${C_RESET}"
    sleep 1
    menu
    exit 0
fi

# 3. PROCESSING
print_status "Locking Account Access"

# Lock Password
passwd -l "$user" > /dev/null 2>&1

# Kill Active Sessions (Tendang user jika sedang login)
pkill -u "$user" > /dev/null 2>&1

# Restart WebSocket Service (Optional, error suppressed)
systemctl restart ws > /dev/null 2>&1

# 4. SUCCESS OUTPUT
clear
echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_CHECK}       ${C_TOMATO}ACCOUNT LOCKED SUCCESSFULLY${C_RESET}        ${C_SAGE}${ICON_LOCK}${C_RESET}        ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
printf " ${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "Username" "$user"
printf " ${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "Status" "Access Denied"
printf " ${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "Action" "Password Locked & Kicked"
echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"

echo -e ""
read -n 1 -s -r -p "Press any key to return..."
menu