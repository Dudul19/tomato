#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - AUTO DELETE EXPIRED
# ==========================================================

# 1. Palette Definition
C_TOMATO="\033[38;2;217;69;57m"
C_BURGUNDY="\033[38;2;143;38;38m"
C_SAGE="\033[38;2;148;180;159m"
C_GOLD="\033[38;2;230;203;165m"
C_CREAM="\033[38;2;253;251;247m"
C_RESET="\033[0m"

# 2. Icons
ICON_TRASH="🗑️"
ICON_SKULL="💀"
ICON_CLEAN="✨"
ICON_CHECK="✔"
ICON_SCAN="🔍"

# 3. Setup
LOG_FILE="/root/xp-activity.log"
NOW=$(date +"%Y-%m-%d")

# ==========================================================
#  HELPER FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}🍅 TOMATO AUTOMATION${C_RESET} ${C_GOLD}(XP / AUTO DELETE)${C_RESET}           ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
    echo -e ""
}

log_action() {
    local msg="$1"
    echo -e "${C_GOLD}[$(date '+%H:%M:%S')]${C_RESET} $msg"
    # Simpan ke file log sistem juga
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $msg" >> "$LOG_FILE"
}

# ==========================================================
#  PROTOCOL HANDLERS
# ==========================================================

# --- 1. VMESS ---
clean_vmess() {
    echo -e "  ${C_GOLD}${ICON_SCAN} Scanning VMess Accounts...${C_RESET}"
    
    # Ambil list user dari config
    grep -E "^### " "/etc/xray/config.json" | cut -d ' ' -f 2 | sort | uniq | while read -r user; do
        exp=$(grep -wE "^### $user" "/etc/xray/config.json" | cut -d ' ' -f 3 | head -n 1)
        
        d1=$(date -d "$exp" +%s)
        d2=$(date -d "$NOW" +%s)
        diff=$(( (d1 - d2) / 86400 ))

        if [[ "$diff" -le 0 ]]; then
            log_action "${ICON_TRASH} Deleting Expired VMess: ${C_TOMATO}$user${C_RESET}"
            
            # Hapus dari Xray Config
            sed -i "/^### $user $exp/,/^},{/d" /etc/xray/config.json
            
            # Hapus dari Database & Files
            sed -i "/^### $user $exp/,/^},{/d" /etc/vmess/.vmess.db 2>/dev/null
            rm -rf /etc/vmess/$user
            rm -rf /etc/kyt/limit/vmess/ip/$user
            rm -rf /etc/vmess/limit/$user
            rm -rf /etc/vmess/quota-asli/$user
            rm -f /var/www/html/vmess-$user.txt
        fi
    done
}

# --- 2. VLESS ---
clean_vless() {
    echo -e "  ${C_GOLD}${ICON_SCAN} Scanning VLESS Accounts...${C_RESET}"
    
    grep -E "^#& " "/etc/xray/config.json" | cut -d ' ' -f 2 | sort | uniq | while read -r user; do
        exp=$(grep -wE "^#& $user" "/etc/xray/config.json" | cut -d ' ' -f 3 | head -n 1)
        
        d1=$(date -d "$exp" +%s)
        d2=$(date -d "$NOW" +%s)
        diff=$(( (d1 - d2) / 86400 ))

        if [[ "$diff" -le 0 ]]; then
            log_action "${ICON_TRASH} Deleting Expired VLESS: ${C_TOMATO}$user${C_RESET}"
            
            sed -i "/^#& $user $exp/,/^},{/d" /etc/xray/config.json
            sed -i "/^#& $user $exp/,/^},{/d" /etc/vless/.vless.db 2>/dev/null
            
            rm -rf /etc/vless/$user
            rm -rf /etc/kyt/limit/vless/ip/$user
            rm -rf /etc/vless/limit/$user
            rm -f /var/www/html/vless-$user.txt
        fi
    done
}

# --- 3. TROJAN ---
clean_trojan() {
    echo -e "  ${C_GOLD}${ICON_SCAN} Scanning Trojan Accounts...${C_RESET}"
    
    grep -E "^#! " "/etc/xray/config.json" | cut -d ' ' -f 2 | sort | uniq | while read -r user; do
        exp=$(grep -wE "^#! $user" "/etc/xray/config.json" | cut -d ' ' -f 3 | head -n 1)
        
        d1=$(date -d "$exp" +%s)
        d2=$(date -d "$NOW" +%s)
        diff=$(( (d1 - d2) / 86400 ))

        if [[ "$diff" -le 0 ]]; then
            log_action "${ICON_TRASH} Deleting Expired Trojan: ${C_TOMATO}$user${C_RESET}"
            
            sed -i "/^#! $user $exp/,/^},{/d" /etc/xray/config.json
            sed -i "/^#! $user $exp/,/^},{/d" /etc/trojan/.trojan.db 2>/dev/null
            
            rm -rf /etc/trojan/$user
            rm -rf /etc/kyt/limit/trojan/ip/$user
            rm -rf /etc/trojan/limit/$user
            rm -f /var/www/html/trojan-$user.txt
        fi
    done
}

# --- 4. SHADOWSOCKS ---
clean_ss() {
    echo -e "  ${C_GOLD}${ICON_SCAN} Scanning Shadowsocks Accounts...${C_RESET}"
    
    grep -E "^#!# " "/etc/xray/config.json" | cut -d ' ' -f 2 | sort | uniq | while read -r user; do
        exp=$(grep -wE "^#!# $user" "/etc/xray/config.json" | cut -d ' ' -f 3 | head -n 1)
        
        d1=$(date -d "$exp" +%s)
        d2=$(date -d "$NOW" +%s)
        diff=$(( (d1 - d2) / 86400 ))

        if [[ "$diff" -le 0 ]]; then
            log_action "${ICON_TRASH} Deleting Expired SS: ${C_TOMATO}$user${C_RESET}"
            
            sed -i "/^#!# $user $exp/,/^},{/d" /etc/xray/config.json
            sed -i "/\b$user\b/d" /etc/shadowsocks/.shadowsocks.db 2>/dev/null
            
            rm -rf /etc/shadowsocks/$user
            rm -rf /etc/kyt/limit/shadowsocks/ip/$user
            rm -f /var/www/html/sodosokws-$user.txt
        fi
    done
}

# --- 5. SSH ---
clean_ssh() {
    echo -e "  ${C_GOLD}${ICON_SCAN} Scanning SSH Accounts...${C_RESET}"
    
    # Mengambil list user dari shadow file yang memiliki field expiry (field 8)
    # Format shadow: user:pass:lastchg:min:max:warn:inact:expire:
    
    cat /etc/shadow | cut -d: -f1,8 | sed /:$/d | while IFS=: read -r user expire_epoch; do
        if [[ ! -z "$expire_epoch" ]]; then
            # Convert epoch days to seconds
            expire_seconds=$((expire_epoch * 86400))
            current_seconds=$(date +%s)
            
            if [[ $current_seconds -ge $expire_seconds ]]; then
                log_action "${ICON_SKULL} Deleting Expired SSH: ${C_TOMATO}$user${C_RESET}"
                
                # Force delete user
                userdel -f "$user" > /dev/null 2>&1
                
                # Cleanup DB & Web Files
                sed -i "/^#ssh# $user /d" /etc/ssh/.ssh.db 2>/dev/null
                rm -f /var/www/html/ssh-$user.txt
            fi
        fi
    done
}

# ==========================================================
#  EXECUTION
# ==========================================================

draw_header

# 1. Execute Cleaners
clean_vmess
clean_vless
clean_trojan
clean_ss
clean_ssh

# 2. Restart Services
echo -e ""
echo -e "  ${C_SAGE}${ICON_CLEAN} Refreshing System Services...${C_RESET}"
systemctl restart xray > /dev/null 2>&1
systemctl reload ssh > /dev/null 2>&1
systemctl reload dropbear > /dev/null 2>&1

echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_CHECK}       ${C_TOMATO}CLEANUP PROCESS COMPLETED${C_RESET}      ${C_SAGE}${ICON_CLEAN}${C_RESET}         ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
echo -e ""