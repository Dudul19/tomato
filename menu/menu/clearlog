#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - LOG CLEANER
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="🍅"
ICON_TRASH="🗑️"
ICON_STAR="✨"
ICON_DISK="💾"
ICON_CHECK="✔"
ICON_GEAR="⚙"
ICON_ARROW="➜"

# ==========================================================
#  HELPER FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_TOMATO}    ${C_TOMATO}TOMATO CLEANER${C_RESET} ${C_GOLD}(SYSTEM LOGS)${C_RESET}               ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR : ${C_CREAM}DUDUL (TEA V.1.0)${C_RESET}                   ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
    echo -e ""
}

print_status() {
    echo -e "  ${C_GOLD}${ICON_GEAR} $1...${C_RESET}"
    sleep 0.5
}

print_success() {
    echo -e "  ${C_SAGE}${ICON_CHECK} SUCCESS:${C_RESET} ${C_CREAM}$1${C_RESET}"
    sleep 0.5
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

draw_header

# 1. Analyze Space Before
print_status "Analyzing Log Size"
# Hitung ukuran folder /var/log sebelum dibersihkan (dalam KB)
size_before=$(du -s /var/log | awk '{print $1}')

# 2. Cleaning Process
echo -e "  ${C_GOLD}${ICON_TRASH} Cleaning System Logs...${C_RESET}"

# Define targets
log_files=(
    "/var/log/syslog"
    "/var/log/btmp"
    "/var/log/messages"
    "/var/log/debug"
    "/var/log/auth.log"
    "/var/log/kern.log"
    "/var/log/cron.log"
    "/var/log/user.log"
    "/var/log/nginx/access.log"
    "/var/log/nginx/error.log"
    "/var/log/xray/access.log"
    "/var/log/xray/error.log"
)

# Clear Specific Files
for log in "${log_files[@]}"; do
    if [[ -f "$log" ]]; then
        > "$log"
    fi
done

# Clear Patterns (Wildcards)
find /var/log -name "*.log" -type f -exec truncate -s 0 {} \;
find /var/log -name "*.err" -type f -exec truncate -s 0 {} \;
find /var/log -name "mail.*" -type f -exec truncate -s 0 {} \;
find /var/log -name "*.gz" -type f -delete  # Hapus log lama yang terkompresi (optional)

# 3. Analyze Space After
size_after=$(du -s /var/log | awk '{print $1}')

# 4. Calculate Reclaimed Space
reclaimed_kb=$((size_before - size_after))
# Convert to MB if > 1024 KB
if [[ $reclaimed_kb -gt 1024 ]]; then
    reclaimed_mb=$(echo "scale=2; $reclaimed_kb / 1024" | bc)
    reclaimed_display="${reclaimed_mb} MB"
else
    reclaimed_display="${reclaimed_kb} KB"
fi

print_success "Logs Cleared Successfully"

# ==========================================================
#  TELEGRAM NOTIFICATION
# ==========================================================
MYIP=$(curl -sS ipv4.icanhazip.com)
CHATID=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3)
KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 2)
TIME="10"
URL="https://api.telegram.org/bot$KEY/sendMessage"

if [[ ! -z "$CHATID" && ! -z "$KEY" ]]; then
    print_status "Sending Notification"
    TEXT="
<code>◇━━━━━━━━━━━━━━━━━━━━━━◇</code>
<b>  🍅 LOG CLEANER REPORT 🍅</b>
<code>◇━━━━━━━━━━━━━━━━━━━━━━◇</code>
<b>IP VPS   :</b> <code>$MYIP</code>
<b>Action   :</b> <code>Clear System Logs</code>
<b>Reclaimed:</b> <code>$reclaimed_display</code>
<b>Status   :</b> <code>Success</code>
<code>◇━━━━━━━━━━━━━━━━━━━━━━◇</code>
<code>Automated by Tomato Autoscript</code>
"
    curl -s --max-time $TIME -d "chat_id=$CHATID&disable_web_page_preview=1&text=$TEXT&parse_mode=html" $URL >/dev/null
fi

# ==========================================================
#  FINAL REPORT
# ==========================================================
echo -e ""
echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_DISK}       ${C_TOMATO}CLEANING REPORT SUMMARY${C_RESET}        ${C_SAGE}${ICON_DISK}${C_RESET}         ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-20s${C_RESET} : ${C_CREAM}%-27s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Log Size Before" "$((size_before / 1024)) MB"
printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-20s${C_RESET} : ${C_CREAM}%-27s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Log Size After" "$((size_after / 1024)) MB"
echo -e "${C_BURGUNDY}╟──────────────────────────────────────────────────────╢${C_RESET}"
printf " ${C_BURGUNDY}║${C_RESET} ${C_SAGE}%-20s${C_RESET} : ${C_SAGE}%-27s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Space Reclaimed" "$reclaimed_display"
echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"

echo -e ""
echo -e "  ${C_GOLD}${ICON_ARROW} Back to menu in 2 seconds...${C_RESET}"
sleep 2
menu