#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - SYSTEM CLEANER
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="๐"
ICON_STAR="โจ"
ICON_TRASH="๐งน"
ICON_RAM="๐พ"
ICON_CHECK="โ"
ICON_GEAR="โ"
ICON_ARROW="โ"

# ==========================================================
#  HELPER FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${C_RESET}"
    echo -e "${C_BURGUNDY}โ${C_RESET} ${C_SAGE}${ICON_TOMATO}    ${C_TOMATO}TOMATO CLEANER${C_RESET} ${C_GOLD}(RAM & CACHE)${C_RESET}               ${C_BURGUNDY}โ${C_RESET}"
    echo -e "${C_BURGUNDY}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ${C_RESET}"
    echo -e "${C_BURGUNDY}โ${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR : ${C_CREAM}DUDUL (TEA V.1.0)${C_RESET}                   ${C_BURGUNDY}โ${C_RESET}"
    echo -e "${C_BURGUNDY}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${C_RESET}"
    echo -e ""
}

print_status() {
    echo -e "  ${C_GOLD}${ICON_GEAR} $1...${C_RESET}"
    sleep 0.5
}

print_success() {
    echo -e "  ${C_SAGE}${ICON_CHECK} SUCCESS:${C_RESET} ${C_CREAM}$1${C_RESET}"
    sleep 0.5
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

draw_header

# 1. Check RAM Before
print_status "Analyzing System Memory"
# Mengambil nilai Buff/Cache (Kolom 6 pada output free -m)
ram_before=$(free -m | awk 'NR==2 {print $6}')
total_ram=$(free -m | awk 'NR==2 {print $2}')

# 2. Perform Cleaning
echo -e "  ${C_GOLD}${ICON_TRASH} Clearing RAM Cache...${C_RESET}"
# Sync filesystem to prevent data loss
sync 
# Drop PageCache, dentries, and inodes
echo 3 > /proc/sys/vm/drop_caches 
sleep 1

# 3. Check RAM After
ram_after=$(free -m | awk 'NR==2 {print $6}')
# Hitung selisih (yang dibebaskan)
freed_space=$((ram_before - ram_after))

# Jika hasil negatif (jarang terjadi, tapi preventif), set ke 0
if [[ $freed_space -lt 0 ]]; then freed_space=0; fi

print_success "System Cache Cleared"

# ==========================================================
#  TELEGRAM NOTIFICATION
# ==========================================================
MYIP=$(curl -sS ipv4.icanhazip.com)
CHATID=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3)
KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 2)
TIME="10"
URL="https://api.telegram.org/bot$KEY/sendMessage"

if [[ ! -z "$CHATID" && ! -z "$KEY" ]]; then
    print_status "Sending Notification"
    TEXT="
<code>โโโโโโโโโโโโโโโโโโโโโโโโ</code>
<b>  ๐ SYSTEM CLEANER ๐</b>
<code>โโโโโโโโโโโโโโโโโโโโโโโโ</code>
<b>IP VPS   :</b> <code>$MYIP</code>
<b>Action   :</b> <code>Clear RAM Cache</code>
<b>Freed    :</b> <code>${freed_space} MB</code>
<b>Status   :</b> <code>Success</code>
<code>โโโโโโโโโโโโโโโโโโโโโโโโ</code>
<code>Automated by Tomato Autoscript</code>
"
    curl -s --max-time $TIME -d "chat_id=$CHATID&disable_web_page_preview=1&text=$TEXT&parse_mode=html" $URL >/dev/null
fi

# ==========================================================
#  FINAL REPORT
# ==========================================================
echo -e ""
echo -e "${C_BURGUNDY}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${C_RESET}"
echo -e "${C_BURGUNDY}โ${C_RESET} ${C_SAGE}${ICON_RAM}       ${C_TOMATO}CLEANING REPORT SUMMARY${C_RESET}        ${C_SAGE}${ICON_RAM}${C_RESET}         ${C_BURGUNDY}โ${C_RESET}"
echo -e "${C_BURGUNDY}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ${C_RESET}"
printf " ${C_BURGUNDY}โ${C_RESET} ${C_GOLD}%-20s${C_RESET} : ${C_CREAM}%-27s${C_RESET} ${C_BURGUNDY}โ${C_RESET}\n" "Total RAM" "${total_ram} MB"
printf " ${C_BURGUNDY}โ${C_RESET} ${C_GOLD}%-20s${C_RESET} : ${C_CREAM}%-27s${C_RESET} ${C_BURGUNDY}โ${C_RESET}\n" "Cache Before" "${ram_before} MB"
printf " ${C_BURGUNDY}โ${C_RESET} ${C_GOLD}%-20s${C_RESET} : ${C_CREAM}%-27s${C_RESET} ${C_BURGUNDY}โ${C_RESET}\n" "Cache After" "${ram_after} MB"
echo -e "${C_BURGUNDY}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโข${C_RESET}"
printf " ${C_BURGUNDY}โ${C_RESET} ${C_SAGE}%-20s${C_RESET} : ${C_SAGE}%-27s${C_RESET} ${C_BURGUNDY}โ${C_RESET}\n" "Space Freed" "${freed_space} MB"
echo -e "${C_BURGUNDY}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${C_RESET}"

echo -e ""
echo -e "  ${C_GOLD}${ICON_ARROW} Back to menu in 2 seconds...${C_RESET}"
sleep 2
menu