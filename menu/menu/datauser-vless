#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - VLESS CHECKER
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="🍅"
ICON_STAR="✨"
ICON_USER="👤"
ICON_KEY="🔑"
ICON_GLOBE="🌐"
ICON_CHECK="✔"
ICON_CROSS="✖"
ICON_GEAR="⚙"
ICON_LINK="🔗"
ICON_LIST="📜"

# ==========================================================
#  HELPER FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_TOMATO}    ${C_TOMATO}TOMATO CHECKER${C_RESET} ${C_GOLD}(VLESS DETAILS)${C_RESET}             ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR : ${C_CREAM}HOKAGE LEGEND${C_RESET}                       ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
    echo -e ""
}

print_status() {
    echo -e "  ${C_GOLD}${ICON_GEAR} $1...${C_RESET}"
    sleep 0.5
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

draw_header

# --- 1. LIST USERS ---
echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
echo -e "${C_BURGUNDY}  |${C_RESET}               ${C_GOLD}REGISTERED USERS${C_RESET}                     ${C_BURGUNDY}|${C_RESET}"
echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"

# Ambil list user dari config (Format VLESS biasanya: #& username exp)
# Kita cari #& dulu, kalau kosong coba cari ### (fallback)
user_list=$(grep -E "^#& " "/etc/xray/config.json" | cut -d ' ' -f 2 | sort | uniq)
if [[ -z "$user_list" ]]; then
    user_list=$(grep -E "^### " "/etc/xray/config.json" | cut -d ' ' -f 2 | sort | uniq)
fi

if [[ -z "$user_list" ]]; then
    echo -e "  ${C_TOMATO}${ICON_CROSS} No Vless users found.${C_RESET}"
    echo -e ""
    read -n 1 -s -r -p "Press any key to return..."
    m-vless
    exit
else
    # Tampilkan user dalam 2 kolom
    echo "$user_list" | pr -2 -t -w 60 | while IFS= read -r line; do
        echo -e "  ${C_CREAM}${line}${C_RESET}"
    done
fi
echo -e "${C_BURGUNDY}  ──────────────────────────────────────────────────────${C_RESET}"
echo -e ""

# --- 2. INPUT USER ---
echo -e "  ${C_GOLD}[?] Input Username to Check :${C_RESET}"
read -p "      > " user

# Validasi User
if [[ -z "$user" ]]; then
    echo -e "  ${C_TOMATO}${ICON_CROSS} Error: Input cannot be empty.${C_RESET}"
    sleep 1
    m-vless
    exit
fi

# Cek apakah user ada di config (Cek kedua tipe marker)
if ! grep -q "$user" "/etc/xray/config.json"; then
    echo -e "  ${C_TOMATO}${ICON_CROSS} Error: User '$user' not found.${C_RESET}"
    sleep 1
    m-vless
    exit
fi

# --- 3. GET DATA ---
print_status "Fetching Account Details"

# Load Configs
CITY=$(cat /etc/xray/city 2>/dev/null || echo "Unknown")
ISP=$(cat /etc/xray/isp 2>/dev/null || echo "Unknown")
domain=$(cat /etc/xray/domain 2>/dev/null)

# Load Limits & Quota
iplimit=$(cat /etc/kyt/limit/vless/ip/$user 2>/dev/null || echo "Unlimited")

if [[ -e /etc/vless/$user ]]; then
    QuotaBytes=$(cat /etc/vless/$user)
    QuotaGB=$((QuotaBytes / 1024 / 1024 / 1024))
else
    QuotaGB="0"
fi

# Load UUID & Exp
# Logic: Cari baris komentar user, lalu ambil ID di blok json dibawahnya
uuid=$(cat /etc/xray/config.json | grep -w "$user" -A 1 | grep "id" | cut -d '"' -f 4 | head -1)
# Fallback jika logic atas gagal
if [[ -z "$uuid" ]]; then
    uuid=$(grep -E "^},{" "/etc/xray/config.json" | grep -i "\"${user}\"" | cut -d " " -f 2 | cut -d '"' -f 2 | uniq | head -1)
fi

# Ambil Expired (Coba #& dulu, lalu ###)
exp=$(grep -E "^#& " "/etc/xray/config.json" | grep -w "$user" | cut -d ' ' -f 3 | head -1)
if [[ -z "$exp" ]]; then
    exp=$(grep -E "^### " "/etc/xray/config.json" | grep -w "$user" | cut -d ' ' -f 3 | head -1)
fi

# Generate Links
vlesslink1="vless://${uuid}@${domain}:443?path=/vless&security=tls&encryption=none&type=ws#${user}"
vlesslink2="vless://${uuid}@${domain}:80?path=/vless&encryption=none&type=ws#${user}"
vlesslink3="vless://${uuid}@${domain}:443?mode=gun&security=tls&encryption=none&type=grpc&serviceName=vless-grpc&sni=${domain}#${user}"

# --- 4. DISPLAY RESULT ---
clear
echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_CHECK}       ${C_TOMATO}ACCOUNT DETAILS RETRIEVED${C_RESET}      ${C_SAGE}${ICON_LIST}${C_RESET}        ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
# Account Info
printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Username" "$user"
printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Expired" "$exp"
printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "IP Limit" "$iplimit Device(s)"
printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Quota" "$QuotaGB GB"
printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Host/IP" "$domain"
printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "ISP" "$ISP"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
# Config Info
printf " ${C_BURGUNDY}║${C_RESET} ${C_SAGE}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Port TLS" "443"
printf " ${C_BURGUNDY}║${C_RESET} ${C_SAGE}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Port NTLS" "80"
printf " ${C_BURGUNDY}║${C_RESET} ${C_SAGE}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Path WS" "/vless"
printf " ${C_BURGUNDY}║${C_RESET} ${C_SAGE}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Service" "vless-grpc"
printf " ${C_BURGUNDY}║${C_RESET} ${C_SAGE}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "UUID" "${uuid}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
# Links
echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_LINK} LINK WS TLS${C_RESET}                                       ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_CREAM}${vlesslink1}${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_LINK} LINK WS NON-TLS${C_RESET}                                   ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_CREAM}${vlesslink2}${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_LINK} LINK GRPC${C_RESET}                                         ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_CREAM}${vlesslink3}${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_GLOBE} OPENCLASH CONFIG${C_RESET}                                  ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_CREAM}https://${domain}:81/vless-$user.txt${C_RESET}"
echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"

# --- 5. FOOTER ---
echo -e ""
echo -e "${C_BURGUNDY}  ──────────────────────────────────────────────────────${C_RESET}"
echo -e "  ${C_GOLD}${ICON_STAR} Thank you for using Tomato Autoscript ${ICON_STAR}${C_RESET}"
echo -e "${C_BURGUNDY}  ──────────────────────────────────────────────────────${C_RESET}"
echo -e ""
read -n 1 -s -r -p "Press any key to return..."
m-vless