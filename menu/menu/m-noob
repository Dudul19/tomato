#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - UDP MANAGER
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="🍅"
ICON_UDP="📡"
ICON_ADD="➕"
ICON_DEL="➖"
ICON_RENEW="🔄"
ICON_LOCK="🔒"
ICON_UNLOCK="🔓"
ICON_LIST="📜"
ICON_STAR="✨"
ICON_WARN="⚠️"

# 3. Check UDP Core
# Pastikan binary 'kyt' ada, jika tidak, coba 'HOKAGE', atau beri warning
UDP_CORE="kyt"
if ! command -v kyt &> /dev/null; then
    if command -v HOKAGE &> /dev/null; then
        UDP_CORE="HOKAGE"
    else
        echo -e "${C_TOMATO}${ICON_WARN} Error: UDP Core (kyt/HOKAGE) not found!${C_RESET}"
        sleep 2
        menu
        exit 1
    fi
fi

# ==========================================================
#  PERMISSION CHECK
# ==========================================================
IPVPES="https://raw.githubusercontent.com/dudul19/tomato/main/izin"
function checking_sc() {
    ipsaya=$(curl -sS ipv4.icanhazip.com)
    data_server=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
    date_list=$(date +"%Y-%m-%d" -d "$data_server")
    useexp=$(wget -qO- $IPVPES | grep $ipsaya | awk '{print $3}')
    if [[ "$date_list" > "$useexp" ]]; then
        clear
        echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
        echo -e "${C_BURGUNDY}║${C_RESET}              ${C_TOMATO}🚫 ACCESS DENIED 🚫${C_RESET}                     ${C_BURGUNDY}║${C_RESET}"
        echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
        exit 1
    fi
}
checking_sc

# ==========================================================
#  HELPER FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_TOMATO}    ${C_TOMATO}TOMATO MANAGER${C_RESET} ${C_GOLD}(UDP HYSTERIA)${C_RESET}             ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR : ${C_CREAM}DUDUL (TEA V.1.0)${C_RESET}                   ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
    echo -e ""
}

print_status() {
    echo -e "  ${C_GOLD}${ICON_GEAR} $1...${C_RESET}"
    sleep 0.5
}

# ==========================================================
#  FEATURE FUNCTIONS
# ==========================================================

function create(){
    draw_header
    echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
    echo -e "${C_BURGUNDY}  |${C_RESET}                 ${C_GOLD}CREATE ACCOUNT${C_RESET}                       ${C_BURGUNDY}|${C_RESET}"
    echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"
    
    read -p "  ${ICON_ADD} Username : " user
    read -p "  ${ICON_LOCK} Password : " pass
    read -p "  ${ICON_RENEW} Expired (Days): " exp
    read -p "  ${ICON_UDP} IP Limit : " ip

    if [[ -z "$user" || -z "$pass" ]]; then
        echo -e "  ${C_TOMATO}Error: Username/Password cannot be empty.${C_RESET}"
        sleep 1
        return
    fi

    # Save Limit IP (Standardized Path)
    mkdir -p /etc/kyt/limit/udp/ip/
    echo "$ip" > /etc/kyt/limit/udp/ip/$user

    print_status "Creating Account"
    $UDP_CORE --add-user $user $pass --expired-user $user $exp > /dev/null

    clear
    echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_CHECK}       ${C_TOMATO}UDP ACCOUNT CREATED${C_RESET}          ${C_SAGE}${ICON_UDP}${C_RESET}        ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
    printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Username" "$user"
    printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Password" "$pass"
    printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Expired" "$exp Days"
    printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "IP Limit" "$ip"
    printf " ${C_BURGUNDY}║${C_RESET} ${C_GOLD}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "Domain" "$(cat /etc/xray/domain 2>/dev/null)"
    echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
    printf " ${C_BURGUNDY}║${C_RESET} ${C_SAGE}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "TCP STD" "2082, 8080"
    printf " ${C_BURGUNDY}║${C_RESET} ${C_SAGE}%-12s${C_RESET} ${C_CREAM}: %-35s${C_RESET} ${C_BURGUNDY}║${C_RESET}\n" "TCP SSL" "8443"
    echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
    
    echo -e ""
    echo -e "${C_GOLD}Example Config TCP_STD (2082,8080):${C_RESET}"
    echo -e "${C_CREAM}EJrIfen5qGdVYT5k7bQgnZQPpd5vVPkchArH8YQlK0rceZ7rgssiVPWGid2nI5mWEBaCBAUXmCO9lqIlEkGWQEy6jqWc4fKhtS5aWomNVX1/Hgd8p0fzQe2aTtMY6Md/J4hd9ssK7VZLpcPL74i5zkFeBGX+iUuT3Zgexuje5LUdkWzusa/sHgU3kPnbAZIEWO26ghc7GVjxJGbJKcDRnf2ufhV5iHkyI1NoXQlx+b5hFfjVAFEpZWyAGla1DR7Zn7Tp3G/GPqUEVrJ0SFClBMhVOv40/SwIdTrqLeDcxjStCd/14TDXNdlEHQbsvRd2zfBKoCTnWRKmvx2kmFRP+zy9KzkW6EemJt5zIIgYwirBpX/loDpHzfblaUGL2+WN/0LRD/TInoK2WX33WM+JDgG/XiWyy5h3xgAyAvgx4rLtuYX+m/kgx+p+CxBpZFJ1CZ09ThaPRjsoO6aG+6edEHZTmk9cxjGgXW/ou5wL8XcFt9xwKBYyLR4t+JD+8o9kxZdc+ZJsi0QJq6gw5NqfiDB6OKWYcYdpXvIrOa+mpc2RDa/7Ra4RVg1tLsRQ4+IxJ6gQRm1T3ydkW71UKcW9kYvSyhPWpZYg5GkjZI5YGRl9e4Y8ujk=${C_RESET}"
    echo -e ""
    
    read -n 1 -s -r -p "Press any key to return..."
}

function delete(){
    draw_header
    echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
    echo -e "${C_BURGUNDY}  |${C_RESET}                 ${C_GOLD}DELETE ACCOUNT${C_RESET}                       ${C_BURGUNDY}|${C_RESET}"
    echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"
    read -p "  ${ICON_DEL} Username : " user

    print_status "Deleting Account"
    $UDP_CORE --remove-user $user > /dev/null
    rm -f /etc/kyt/limit/udp/ip/$user
    
    echo -e "  ${C_SAGE}${ICON_CHECK} Account '$user' Deleted Successfully.${C_RESET}"
    read -n 1 -s -r -p "Press any key to return..."
}

function renew(){
    draw_header
    echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
    echo -e "${C_BURGUNDY}  |${C_RESET}                 ${C_GOLD}RENEW ACCOUNT${C_RESET}                        ${C_BURGUNDY}|${C_RESET}"
    echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"
    read -p "  ${ICON_ADD} Username : " user
    read -p "  ${ICON_RENEW} Add Days : " exp

    print_status "Renewing Account"
    $UDP_CORE --renew-user $user --expired-user $user $exp > /dev/null
    
    echo -e "  ${C_SAGE}${ICON_CHECK} Account '$user' Renewed Successfully.${C_RESET}"
    read -n 1 -s -r -p "Press any key to return..."
}

function lock(){
    draw_header
    echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
    echo -e "${C_BURGUNDY}  |${C_RESET}                  ${C_GOLD}LOCK ACCOUNT${C_RESET}                        ${C_BURGUNDY}|${C_RESET}"
    echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"
    read -p "  ${ICON_LOCK} Username : " user
    
    $UDP_CORE --block-user $user > /dev/null
    echo -e "  ${C_SAGE}${ICON_CHECK} Account '$user' Locked.${C_RESET}"
    read -n 1 -s -r -p "Press any key to return..."
}

function unlock(){
    draw_header
    echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
    echo -e "${C_BURGUNDY}  |${C_RESET}                 ${C_GOLD}UNLOCK ACCOUNT${C_RESET}                       ${C_BURGUNDY}|${C_RESET}"
    echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"
    read -p "  ${ICON_UNLOCK} Username : " user
    
    $UDP_CORE --unblock-user $user > /dev/null
    echo -e "  ${C_SAGE}${ICON_CHECK} Account '$user' Unlocked.${C_RESET}"
    read -n 1 -s -r -p "Press any key to return..."
}

function show(){
    draw_header
    echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
    echo -e "${C_BURGUNDY}  |${C_RESET}                 ${C_GOLD}USER LIST${C_RESET}                            ${C_BURGUNDY}|${C_RESET}"
    echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"
    # Gunakan awk untuk merapikan output kyt --info-all-user
    $UDP_CORE --info-all-user | grep -E "user:|expired:|status:" | awk '
    BEGIN { print "  USERNAME             EXPIRED        STATUS" }
    /user:/ { u=$2 }
    /expired:/ { e=$2 }
    /status:/ { 
        printf "  %-20s %-14s %-10s\n", u, e, $2
    }'
    echo -e "${C_BURGUNDY}  ──────────────────────────────────────────────────────${C_RESET}"
    echo -e ""
    read -n 1 -s -r -p "Press any key to return..."
}

function remove_all(){
    draw_header
    echo -e "${C_GOLD}[?] Are you sure you want to DELETE ALL UDP USERS? (y/n)${C_RESET}"
    read -p "    > " choice
    
    if [[ "$choice" == "y" || "$choice" == "Y" ]]; then
        print_status "Deleting All Users"
        $UDP_CORE --remove-all-user > /dev/null
        rm -rf /etc/kyt/limit/udp/ip/*
        echo -e "  ${C_SAGE}${ICON_CHECK} All UDP Users Deleted.${C_RESET}"
    else
        echo -e "  ${C_TOMATO}Cancelled.${C_RESET}"
    fi
    sleep 1
}

# ==========================================================
#  MAIN MENU
# ==========================================================

draw_header

echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}[01]${C_RESET} ${C_CREAM}Create Account${C_RESET}        ${C_SAGE}${ICON_ADD}${C_RESET}                        ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}[02]${C_RESET} ${C_CREAM}Delete Account${C_RESET}        ${C_TOMATO}${ICON_DEL}${C_RESET}                        ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}[03]${C_RESET} ${C_CREAM}Renew Account${C_RESET}         ${C_SAGE}${ICON_RENEW}${C_RESET}                        ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}[04]${C_RESET} ${C_CREAM}Lock Account${C_RESET}          ${C_TOMATO}${ICON_LOCK}${C_RESET}                        ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}[05]${C_RESET} ${C_CREAM}Unlock Account${C_RESET}        ${C_SAGE}${ICON_UNLOCK}${C_RESET}                        ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}[06]${C_RESET} ${C_CREAM}List All Users${C_RESET}        ${C_SAGE}${ICON_LIST}${C_RESET}                        ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}[07]${C_RESET} ${C_CREAM}Delete All Users${C_RESET}      ${C_TOMATO}${ICON_TRASH}${C_RESET}                        ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_TOMATO}[00]${C_RESET} ${C_TOMATO}Back to Main Menu${C_RESET}     ${C_GOLD}${ICON_STAR}${C_RESET}                        ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
echo -e ""

read -p "  Select Option : " opt
echo -e ""

case $opt in
    01|1) create ;;
    02|2) delete ;;
    03|3) renew ;;
    04|4) lock ;;
    05|5) unlock ;;
    06|6) show ;;
    07|7) remove_all ;;
    00|0) menu ;;
    *) menu ;;
esac

menu